<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>common lisp graphics</title><!-- for google analytics -->
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QNNF19VZGH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-QNNF19VZGH');
</script>

<!-- lambda icon, frail attempt -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%221em%22 font-size=%22100%22 color=%22red%22>Î»</text></svg>">
<!-- not-so-awesome awesome font -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="stylesheet" href="/main.css">
<!-- for dark mode -->
<script src="darkmode.js"></script>
<script src="main.js"></script>
<script src="https://unpkg.com/feather-icons"></script>
</head>
<body>
<div id="preamble" class="status">
<div class="navbar">
  <a href='/'>home</a>
  <a href='/blog.html'>blog</a>
  <a href='/search.html'>search</a>
  <a href='/about.html'>about</a>
  <div id="darkModeToggle" onclick="toggleDarkMode()">
    &#9680; <!-- Circle with left half black -->
  </div>
</div>
<div class="toc">
  <span class="toc-title-container">
    <a class='feather' data-feather='menu'></a>
    <span class="toc-title">table of contents</span>
  </span>
  <div class="toc-list">
  </div>
</div><h1 class="main-title">common lisp graphics</h1><span class='date'>2023-05-21</span>
</div>
<div id="content" class="content">
<p>
we need the libraries <code>sdl2</code>, <code>livesupport</code> (to be able to continue if an error occurs in the main loop) and <code>opengl</code> for rendering.
</p>

<p>
using <a href="/common_lisp.html">quicklisp</a>
</p>
<div class="org-src-container" data-language="lisp">
<pre class="src src-lisp"><span style="color: #deb07a;">(</span>ql:quickload <span style="color: #e3b0c0; font-weight: bold;">:sdl2</span><span style="color: #deb07a;">)</span>
<span style="color: #deb07a;">(</span>ql:quickload <span style="color: #e3b0c0; font-weight: bold;">:livesupport</span><span style="color: #deb07a;">)</span>
<span style="color: #deb07a;">(</span>ql:quickload <span style="color: #e3b0c0; font-weight: bold;">:cl-opengl</span><span style="color: #deb07a;">)</span>
</pre>
</div>

<p>
here im implementing an abstraction layer over opengl/sdl2 to be able to render things like math functions easily
we need a generic way to represent objects that are renderable onto a window so we use the generic function <code>render</code> and implement it in the various classes
</p>
<div class="org-src-container" data-language="lisp">
<pre class="src src-lisp"><span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defgeneric</span> <span style="color: #8fcfd0;">render</span> <span style="color: #ffaacf;">(</span>obj<span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span><span style="color: #e3b0c0; font-weight: bold;">:documentation</span> <span style="color: #caa89f; font-style: italic;">"a function to render the object in an opengl context"</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defstruct</span> <span style="color: #a9c99f;">rgb</span>
  <span style="color: #caa89f; font-style: italic;">"rgb color"</span>
  <span style="color: #ffaacf;">(</span>r 0<span style="color: #ffaacf;">)</span> <span style="color: #ffaacf;">(</span>g 0<span style="color: #ffaacf;">)</span> <span style="color: #ffaacf;">(</span>b 0<span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defstruct</span> <span style="color: #a9c99f;">point-2d</span> <span style="color: #ffaacf;">()</span>
  x y <span style="color: #ffaacf;">(</span>color <span style="color: #80aadf;">(</span>make-rgb <span style="color: #e3b0c0; font-weight: bold;">:r</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:b</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:g</span> 0<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">render</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>p point-2d<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span>gl:with-primitives <span style="color: #e3b0c0; font-weight: bold;">:points</span>
    <span style="color: #80aadf;">(</span>gl:vertex <span style="color: #e47980;">(</span>point-2d-x p<span style="color: #e47980;">)</span> <span style="color: #e47980;">(</span>point-2d-y p<span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defstruct</span> <span style="color: #a9c99f;">line-2d</span>
  point1 point2 <span style="color: #ffaacf;">(</span>color <span style="color: #80aadf;">(</span>make-rgb <span style="color: #e3b0c0; font-weight: bold;">:r</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:b</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:g</span> 0<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span> <span style="color: #ffaacf;">(</span>width 1<span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">render</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>line line-2d<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">let</span> <span style="color: #80aadf;">(</span><span style="color: #e47980;">(</span>point1 <span style="color: #d0b0ff;">(</span>line-2d-point1 line<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
        <span style="color: #e47980;">(</span>point2 <span style="color: #d0b0ff;">(</span>line-2d-point2 line<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
        <span style="color: #e47980;">(</span>width <span style="color: #d0b0ff;">(</span>line-2d-width line<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span>gl:line-width width<span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span>gl:with-primitives
        <span style="color: #e3b0c0; font-weight: bold;">:lines</span>
      <span style="color: #e47980;">(</span>gl:vertex <span style="color: #d0b0ff;">(</span>point-2d-x point1<span style="color: #d0b0ff;">)</span> <span style="color: #d0b0ff;">(</span>point-2d-y point1<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
      <span style="color: #e47980;">(</span>gl:vertex <span style="color: #d0b0ff;">(</span>point-2d-x point2<span style="color: #d0b0ff;">)</span> <span style="color: #d0b0ff;">(</span>point-2d-y point2<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defclass</span> <span style="color: #a9c99f;">window</span> <span style="color: #ffaacf;">()</span>
  <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>draw-axis <span style="color: #e3b0c0; font-weight: bold;">:initarg</span> <span style="color: #e3b0c0; font-weight: bold;">:draw-axis</span> <span style="color: #e3b0c0; font-weight: bold;">:accessor</span> window-draw-axis<span style="color: #80aadf;">)</span>
   <span style="color: #80aadf;">(</span>renderables <span style="color: #e3b0c0; font-weight: bold;">:initform</span> '<span style="color: #e47980;">()</span> <span style="color: #e3b0c0; font-weight: bold;">:accessor</span> window-renderables<span style="color: #80aadf;">)</span>
   <span style="color: #80aadf;">(</span>width <span style="color: #e3b0c0; font-weight: bold;">:initarg</span> <span style="color: #e3b0c0; font-weight: bold;">:width</span> <span style="color: #e3b0c0; font-weight: bold;">:initform</span> 750 <span style="color: #e3b0c0; font-weight: bold;">:accessor</span> window-width<span style="color: #80aadf;">)</span>
   <span style="color: #80aadf;">(</span>height <span style="color: #e3b0c0; font-weight: bold;">:initarg</span> <span style="color: #e3b0c0; font-weight: bold;">:height</span> <span style="color: #e3b0c0; font-weight: bold;">:initform</span> 750 <span style="color: #e3b0c0; font-weight: bold;">:accessor</span> window-height<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">window-run</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>my-window window<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span>sdl2:with-init <span style="color: #80aadf;">(</span><span style="color: #e3b0c0; font-weight: bold;">:everything</span><span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span>format t <span style="color: #f3a0a0;">"Using SDL Library Version: ~D.~D.~D~%"</span>
            sdl2-ffi:+sdl-major-version+
            sdl2-ffi:+sdl-minor-version+
            sdl2-ffi:+sdl-patchlevel+<span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span>sdl2:with-window
        <span style="color: #e47980;">(</span>sdl-window
         <span style="color: #e3b0c0; font-weight: bold;">:title</span> <span style="color: #f3a0a0;">"basic graphics"</span>
         <span style="color: #e3b0c0; font-weight: bold;">:flags</span> '<span style="color: #d0b0ff;">(</span><span style="color: #e3b0c0; font-weight: bold;">:shown</span> <span style="color: #e3b0c0; font-weight: bold;">:opengl</span><span style="color: #d0b0ff;">)</span>
         <span style="color: #e3b0c0; font-weight: bold;">:w</span> <span style="color: #d0b0ff;">(</span>window-width my-window<span style="color: #d0b0ff;">)</span>
         <span style="color: #e3b0c0; font-weight: bold;">:h</span> <span style="color: #d0b0ff;">(</span>window-height my-window<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
      <span style="color: #e47980;">(</span>sdl2:with-gl-context <span style="color: #d0b0ff;">(</span>gl-context sdl-window<span style="color: #d0b0ff;">)</span>
        <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">init opengl</span>
        <span style="color: #d0b0ff;">(</span>sdl2:gl-make-current sdl-window gl-context<span style="color: #d0b0ff;">)</span>

        <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">enter main loop</span>
        <span style="color: #d0b0ff;">(</span>sdl2:with-event-loop <span style="color: #3fc489;">(</span><span style="color: #e3b0c0; font-weight: bold;">:method</span> <span style="color: #e3b0c0; font-weight: bold;">:poll</span><span style="color: #3fc489;">)</span>
          <span style="color: #3fc489;">(</span><span style="color: #e3b0c0; font-weight: bold;">:keyup</span> <span style="color: #6fb3c0;">(</span><span style="color: #e3b0c0; font-weight: bold;">:keysym</span> keysym<span style="color: #6fb3c0;">)</span>
                  <span style="color: #6fb3c0;">(</span><span style="color: #deb07a; font-weight: bold;">when</span> <span style="color: #c0b24f;">(</span>sdl2:scancode= <span style="color: #f3a0a0;">(</span>sdl2:scancode-value keysym<span style="color: #f3a0a0;">)</span> <span style="color: #e3b0c0; font-weight: bold;">:scancode-q</span><span style="color: #c0b24f;">)</span>
                    <span style="color: #c0b24f;">(</span>sdl2:push-event <span style="color: #e3b0c0; font-weight: bold;">:quit</span><span style="color: #c0b24f;">)</span><span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span>
          <span style="color: #3fc489;">(</span><span style="color: #e3b0c0; font-weight: bold;">:idle</span>
           <span style="color: #6fb3c0;">()</span>
           <span style="color: #6fb3c0;">(</span>livesupport:update-repl-link<span style="color: #6fb3c0;">)</span> <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">accept requests from slime/sly, for live programming</span>
           <span style="color: #6fb3c0;">(</span>livesupport:continuable <span style="color: #c0b24f;">(</span>window-render my-window<span style="color: #c0b24f;">)</span><span style="color: #6fb3c0;">)</span>
           <span style="color: #6fb3c0;">(</span>sdl2:gl-swap-window sdl-window<span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span>
          <span style="color: #3fc489;">(</span><span style="color: #e3b0c0; font-weight: bold;">:quit</span> <span style="color: #6fb3c0;">()</span> t<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">window-render</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>win window<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #caa89f; font-style: italic;">"render the renderables, using opengl"</span>
  <span style="color: #ffaacf;">(</span>gl:clear-color 255 255 255 1.0<span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span>gl:clear <span style="color: #e3b0c0; font-weight: bold;">:color-buffer</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span> for renderable in <span style="color: #80aadf;">(</span>window-renderables win<span style="color: #80aadf;">)</span>
        do <span style="color: #80aadf;">(</span>gl:matrix-mode <span style="color: #e3b0c0; font-weight: bold;">:projection</span><span style="color: #80aadf;">)</span>
           <span style="color: #80aadf;">(</span>gl:load-identity<span style="color: #80aadf;">)</span> <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">reset matrix to default state</span>
           <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">(gl:ortho -1 1 -1 1 -1 1) ;; normalize window space, not really needed, done by default</span>
           <span style="color: #80aadf;">(</span>gl:viewport 0 0 <span style="color: #e47980;">(</span>window-width win<span style="color: #e47980;">)</span> <span style="color: #e47980;">(</span>window-height win<span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span>
           <span style="color: #80aadf;">(</span>gl:matrix-mode <span style="color: #e3b0c0; font-weight: bold;">:modelview</span><span style="color: #80aadf;">)</span>
           <span style="color: #80aadf;">(</span><span style="color: #deb07a; font-weight: bold;">with-slots</span> <span style="color: #e47980;">(</span>color<span style="color: #e47980;">)</span> renderable
             <span style="color: #e47980;">(</span>gl:color <span style="color: #d0b0ff;">(</span>/ <span style="color: #3fc489;">(</span>rgb-r color<span style="color: #3fc489;">)</span> 255<span style="color: #d0b0ff;">)</span> <span style="color: #d0b0ff;">(</span>/ <span style="color: #3fc489;">(</span>rgb-b color<span style="color: #3fc489;">)</span> 255<span style="color: #d0b0ff;">)</span> <span style="color: #d0b0ff;">(</span>/ <span style="color: #3fc489;">(</span>rgb-g color<span style="color: #3fc489;">)</span> 255<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span>
           <span style="color: #80aadf;">(</span>render renderable<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span>sdl2:delay 20<span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">window-add-renderable</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>win window<span style="color: #80aadf;">)</span> renderable<span style="color: #ffaacf;">)</span>
  <span style="color: #caa89f; font-style: italic;">"add a renderable to renderables, a renderable is an object that has the generic function render"</span>
  <span style="color: #ffaacf;">(</span>push renderable <span style="color: #80aadf;">(</span>window-renderables win<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defstruct</span> <span style="color: #a9c99f;">axis</span>
  <span style="color: #caa89f; font-style: italic;">"a renderable, can hold other renderables which would be drawn locally (transformed), pos is the (point-2d) position in the window"</span>
  <span style="color: #ffaacf;">(</span>renderables '<span style="color: #80aadf;">()</span><span style="color: #ffaacf;">)</span> pos width height <span style="color: #ffaacf;">(</span>color <span style="color: #80aadf;">(</span>make-rgb <span style="color: #e3b0c0; font-weight: bold;">:r</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:b</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:g</span> 0<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">bounds of the axes</span>
  <span style="color: #ffaacf;">(</span>min-y -1<span style="color: #ffaacf;">)</span> <span style="color: #ffaacf;">(</span>max-y 1<span style="color: #ffaacf;">)</span> <span style="color: #ffaacf;">(</span>min-x -1<span style="color: #ffaacf;">)</span> <span style="color: #ffaacf;">(</span>max-x 1<span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">axis-add-renderable</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>a axis<span style="color: #80aadf;">)</span> renderable<span style="color: #ffaacf;">)</span>
  <span style="color: #caa89f; font-style: italic;">"add a renderable to renderables, a renderable is an object that has the generic function render"</span>
  <span style="color: #ffaacf;">(</span>push renderable <span style="color: #80aadf;">(</span>axis-renderables a<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">render</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>a axis<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">with-slots</span> <span style="color: #80aadf;">(</span>min-y min-x max-y max-x width height<span style="color: #80aadf;">)</span> a
    <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">axes view matrix setup</span>
    <span style="color: #80aadf;">(</span>gl:matrix-mode <span style="color: #e3b0c0; font-weight: bold;">:projection</span><span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span>gl:viewport <span style="color: #e47980;">(</span>point-2d-x <span style="color: #d0b0ff;">(</span>axis-pos a<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
                 <span style="color: #e47980;">(</span>point-2d-y <span style="color: #d0b0ff;">(</span>axis-pos a<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
                 width
                 height<span style="color: #80aadf;">)</span>
    <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">apply matirx to make the screenspace correct for original width/height</span>
    <span style="color: #80aadf;">(</span>gl:ortho 0 width 0 height -1 1<span style="color: #80aadf;">)</span>
    <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">render ticks of both axes</span>
    <span style="color: #80aadf;">(</span><span style="color: #deb07a; font-weight: bold;">let</span> <span style="color: #e47980;">(</span><span style="color: #d0b0ff;">(</span>origin <span style="color: #3fc489;">(</span>make-point-2d
                   <span style="color: #e3b0c0; font-weight: bold;">:x</span> <span style="color: #6fb3c0;">(</span>map-num 0 0 width <span style="color: #c0b24f;">(</span>map-num 0 min-x max-x 0 width<span style="color: #c0b24f;">)</span> width<span style="color: #6fb3c0;">)</span>
                   <span style="color: #e3b0c0; font-weight: bold;">:y</span> <span style="color: #6fb3c0;">(</span>map-num 0 0 height <span style="color: #c0b24f;">(</span>map-num 0 min-y max-y 0 height<span style="color: #c0b24f;">)</span> height<span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
      <span style="color: #e47980;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span> for x from <span style="color: #d0b0ff;">(</span>point-2d-x origin<span style="color: #d0b0ff;">)</span> below width by 75
            do <span style="color: #d0b0ff;">(</span>render
                <span style="color: #3fc489;">(</span>make-line-2d
                 <span style="color: #e3b0c0; font-weight: bold;">:point1</span> <span style="color: #6fb3c0;">(</span>make-point-2d
                          <span style="color: #e3b0c0; font-weight: bold;">:x</span> x <span style="color: #e3b0c0; font-weight: bold;">:y</span> <span style="color: #c0b24f;">(</span>- <span style="color: #f3a0a0;">(</span>point-2d-y origin<span style="color: #f3a0a0;">)</span> 10<span style="color: #c0b24f;">)</span><span style="color: #6fb3c0;">)</span>
                 <span style="color: #e3b0c0; font-weight: bold;">:point2</span> <span style="color: #6fb3c0;">(</span>make-point-2d
                          <span style="color: #e3b0c0; font-weight: bold;">:x</span> x <span style="color: #e3b0c0; font-weight: bold;">:y</span> <span style="color: #c0b24f;">(</span>- <span style="color: #f3a0a0;">(</span>point-2d-y origin<span style="color: #f3a0a0;">)</span> -10<span style="color: #c0b24f;">)</span><span style="color: #6fb3c0;">)</span>
                 <span style="color: #e3b0c0; font-weight: bold;">:width</span> 3<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
      <span style="color: #e47980;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span> for x from <span style="color: #d0b0ff;">(</span>point-2d-x origin<span style="color: #d0b0ff;">)</span> above 0 by 75
            do <span style="color: #d0b0ff;">(</span>render
                <span style="color: #3fc489;">(</span>make-line-2d
                 <span style="color: #e3b0c0; font-weight: bold;">:point1</span> <span style="color: #6fb3c0;">(</span>make-point-2d
                          <span style="color: #e3b0c0; font-weight: bold;">:x</span> x <span style="color: #e3b0c0; font-weight: bold;">:y</span> <span style="color: #c0b24f;">(</span>- <span style="color: #f3a0a0;">(</span>point-2d-y origin<span style="color: #f3a0a0;">)</span> 10<span style="color: #c0b24f;">)</span><span style="color: #6fb3c0;">)</span>
                 <span style="color: #e3b0c0; font-weight: bold;">:point2</span> <span style="color: #6fb3c0;">(</span>make-point-2d
                          <span style="color: #e3b0c0; font-weight: bold;">:x</span> x <span style="color: #e3b0c0; font-weight: bold;">:y</span> <span style="color: #c0b24f;">(</span>- <span style="color: #f3a0a0;">(</span>point-2d-y origin<span style="color: #f3a0a0;">)</span> -10<span style="color: #c0b24f;">)</span><span style="color: #6fb3c0;">)</span>
                 <span style="color: #e3b0c0; font-weight: bold;">:width</span> 3<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
      <span style="color: #e47980;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span> for y from <span style="color: #d0b0ff;">(</span>point-2d-y origin<span style="color: #d0b0ff;">)</span> above 0 by 75
              do <span style="color: #d0b0ff;">(</span>render
                  <span style="color: #3fc489;">(</span>make-line-2d
                   <span style="color: #e3b0c0; font-weight: bold;">:point1</span> <span style="color: #6fb3c0;">(</span>make-point-2d
                            <span style="color: #e3b0c0; font-weight: bold;">:x</span> <span style="color: #c0b24f;">(</span>- <span style="color: #f3a0a0;">(</span>point-2d-x origin<span style="color: #f3a0a0;">)</span> 10<span style="color: #c0b24f;">)</span> <span style="color: #e3b0c0; font-weight: bold;">:y</span> y<span style="color: #6fb3c0;">)</span>
                   <span style="color: #e3b0c0; font-weight: bold;">:point2</span> <span style="color: #6fb3c0;">(</span>make-point-2d
                            <span style="color: #e3b0c0; font-weight: bold;">:x</span> <span style="color: #c0b24f;">(</span>- <span style="color: #f3a0a0;">(</span>point-2d-x origin<span style="color: #f3a0a0;">)</span> -10<span style="color: #c0b24f;">)</span> <span style="color: #e3b0c0; font-weight: bold;">:y</span> y<span style="color: #6fb3c0;">)</span>
                   <span style="color: #e3b0c0; font-weight: bold;">:width</span> 3<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
      <span style="color: #e47980;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span> for y from <span style="color: #d0b0ff;">(</span>point-2d-y origin<span style="color: #d0b0ff;">)</span> below height by 75
              do <span style="color: #d0b0ff;">(</span>render
                  <span style="color: #3fc489;">(</span>make-line-2d
                   <span style="color: #e3b0c0; font-weight: bold;">:point1</span> <span style="color: #6fb3c0;">(</span>make-point-2d
                            <span style="color: #e3b0c0; font-weight: bold;">:x</span> <span style="color: #c0b24f;">(</span>- <span style="color: #f3a0a0;">(</span>point-2d-x origin<span style="color: #f3a0a0;">)</span> 10<span style="color: #c0b24f;">)</span> <span style="color: #e3b0c0; font-weight: bold;">:y</span> y<span style="color: #6fb3c0;">)</span>
                   <span style="color: #e3b0c0; font-weight: bold;">:point2</span> <span style="color: #6fb3c0;">(</span>make-point-2d
                            <span style="color: #e3b0c0; font-weight: bold;">:x</span> <span style="color: #c0b24f;">(</span>- <span style="color: #f3a0a0;">(</span>point-2d-x origin<span style="color: #f3a0a0;">)</span> -10<span style="color: #c0b24f;">)</span> <span style="color: #e3b0c0; font-weight: bold;">:y</span> y<span style="color: #6fb3c0;">)</span>
                   <span style="color: #e3b0c0; font-weight: bold;">:width</span> 3<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span>
    <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">reset matrix then apply another matrix so that the screenspace is correct for min/max-x/y</span>
    <span style="color: #80aadf;">(</span>gl:load-identity<span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span>gl:ortho min-x max-x min-y max-y -1 1<span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span>gl:matrix-mode <span style="color: #e3b0c0; font-weight: bold;">:modelview</span><span style="color: #80aadf;">)</span>
    <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">render axes</span>
    <span style="color: #80aadf;">(</span>render
     <span style="color: #e47980;">(</span>make-line-2d
      <span style="color: #e3b0c0; font-weight: bold;">:point1</span> <span style="color: #d0b0ff;">(</span>make-point-2d
               <span style="color: #e3b0c0; font-weight: bold;">:x</span> min-x <span style="color: #e3b0c0; font-weight: bold;">:y</span> 0<span style="color: #d0b0ff;">)</span>
      <span style="color: #e3b0c0; font-weight: bold;">:point2</span> <span style="color: #d0b0ff;">(</span>make-point-2d
               <span style="color: #e3b0c0; font-weight: bold;">:x</span> max-x <span style="color: #e3b0c0; font-weight: bold;">:y</span> 0<span style="color: #d0b0ff;">)</span>
      <span style="color: #e3b0c0; font-weight: bold;">:width</span> 3<span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span>render
     <span style="color: #e47980;">(</span>make-line-2d
      <span style="color: #e3b0c0; font-weight: bold;">:point1</span> <span style="color: #d0b0ff;">(</span>make-point-2d
               <span style="color: #e3b0c0; font-weight: bold;">:x</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:y</span> max-y<span style="color: #d0b0ff;">)</span>
      <span style="color: #e3b0c0; font-weight: bold;">:point2</span> <span style="color: #d0b0ff;">(</span>make-point-2d
               <span style="color: #e3b0c0; font-weight: bold;">:x</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:y</span> min-y<span style="color: #d0b0ff;">)</span>
      <span style="color: #e3b0c0; font-weight: bold;">:width</span> 3<span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span>
    <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">render children (renderables)</span>
    <span style="color: #80aadf;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span> for renderable in <span style="color: #e47980;">(</span>axis-renderables a<span style="color: #e47980;">)</span>
          do <span style="color: #e47980;">(</span>render renderable<span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defstruct</span> <span style="color: #a9c99f;">plot</span>
  <span style="color: #caa89f; font-style: italic;">"lam is the lambda function to call with x (should return y)"</span>
  lam
  <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">bounds of the plot (drawing bound of the plots)</span>
  min-y max-y min-x max-x
  <span style="color: #ffaacf;">(</span>color <span style="color: #80aadf;">(</span>make-rgb <span style="color: #e3b0c0; font-weight: bold;">:r</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:b</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:g</span> 0<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defun</span> <span style="color: #8fcfd0;">map-num</span> <span style="color: #ffaacf;">(</span>num src-min src-max dest-min dest-max<span style="color: #ffaacf;">)</span>
  <span style="color: #caa89f; font-style: italic;">"(map-num 0.5 -1 1 -50 50) =&gt; 25.0"</span>
  <span style="color: #ffaacf;">(</span>/ <span style="color: #80aadf;">(</span>- <span style="color: #e47980;">(</span>+ <span style="color: #d0b0ff;">(</span>* <span style="color: #3fc489;">(</span>- num src-min<span style="color: #3fc489;">)</span> <span style="color: #3fc489;">(</span>- dest-max dest-min<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span> <span style="color: #d0b0ff;">(</span>* dest-min src-max<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span> <span style="color: #e47980;">(</span>* dest-min src-min<span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span> <span style="color: #80aadf;">(</span>- src-max src-min<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">render</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>p plot<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">let</span> <span style="color: #80aadf;">(</span><span style="color: #e47980;">(</span>prev-point nil<span style="color: #e47980;">)</span>
        <span style="color: #e47980;">(</span>lam <span style="color: #d0b0ff;">(</span>plot-lam p<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span> for x from -100 below 100
          do <span style="color: #e47980;">(</span><span style="color: #deb07a; font-weight: bold;">let*</span> <span style="color: #d0b0ff;">(</span><span style="color: #3fc489;">(</span>x <span style="color: #6fb3c0;">(</span>map-num x -100 100 <span style="color: #c0b24f;">(</span>plot-min-x p<span style="color: #c0b24f;">)</span> <span style="color: #c0b24f;">(</span>plot-max-x p<span style="color: #c0b24f;">)</span><span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span>
                    <span style="color: #3fc489;">(</span>new-y <span style="color: #6fb3c0;">(</span>funcall lam x<span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span>
                    <span style="color: #3fc489;">(</span>new-point <span style="color: #6fb3c0;">(</span>make-point-2d <span style="color: #e3b0c0; font-weight: bold;">:x</span> x <span style="color: #e3b0c0; font-weight: bold;">:y</span> new-y<span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span>
               <span style="color: #d0b0ff;">(</span><span style="color: #deb07a; font-weight: bold;">if</span> prev-point
                   <span style="color: #3fc489;">(</span>render <span style="color: #6fb3c0;">(</span>make-line-2d
                            <span style="color: #e3b0c0; font-weight: bold;">:point1</span> prev-point
                            <span style="color: #e3b0c0; font-weight: bold;">:point2</span> new-point<span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span>
               <span style="color: #d0b0ff;">(</span>setf prev-point new-point<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defstruct</span> <span style="color: #a9c99f;">discrete-plot</span>
  <span style="color: #caa89f; font-style: italic;">"a discrete plot, one that connects a finite amount of points"</span>
  points <span style="color: #ffaacf;">(</span>color <span style="color: #80aadf;">(</span>make-rgb <span style="color: #e3b0c0; font-weight: bold;">:r</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:b</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:g</span> 0<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">render</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>p discrete-plot<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">let*</span> <span style="color: #80aadf;">(</span><span style="color: #e47980;">(</span>points <span style="color: #d0b0ff;">(</span>discrete-plot-points p<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
         <span style="color: #e47980;">(</span>prev-point <span style="color: #d0b0ff;">(</span>elt points 0<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span> for i from 1 below <span style="color: #e47980;">(</span>length points<span style="color: #e47980;">)</span>
          do <span style="color: #e47980;">(</span><span style="color: #deb07a; font-weight: bold;">let</span> <span style="color: #d0b0ff;">(</span><span style="color: #3fc489;">(</span>new-point <span style="color: #6fb3c0;">(</span>elt points i<span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span>
               <span style="color: #d0b0ff;">(</span>render <span style="color: #3fc489;">(</span>make-line-2d
                        <span style="color: #e3b0c0; font-weight: bold;">:point1</span> prev-point
                        <span style="color: #e3b0c0; font-weight: bold;">:point2</span> new-point<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span>
               <span style="color: #d0b0ff;">(</span>setf prev-point new-point<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>
</pre>
</div>

<p>
example usage:
</p>
<div class="org-src-container" data-language="lisp">
<pre class="src src-lisp"><span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defun</span> <span style="color: #8fcfd0;">sdl2-test</span> <span style="color: #ffaacf;">()</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">defparameter</span> <span style="color: #ffaacf;">*win*</span> <span style="color: #80aadf;">(</span>make-instance 'window <span style="color: #e3b0c0; font-weight: bold;">:draw-axis</span> t <span style="color: #e3b0c0; font-weight: bold;">:width</span> 750 <span style="color: #e3b0c0; font-weight: bold;">:height</span> 750<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">defparameter</span> <span style="color: #ffaacf;">*axis*</span> <span style="color: #80aadf;">(</span>make-axis
                        <span style="color: #e3b0c0; font-weight: bold;">:min-x</span> -1
                        <span style="color: #e3b0c0; font-weight: bold;">:max-x</span> 3
                        <span style="color: #e3b0c0; font-weight: bold;">:max-y</span> 3
                        <span style="color: #e3b0c0; font-weight: bold;">:min-y</span> -1
                        <span style="color: #e3b0c0; font-weight: bold;">:pos</span> <span style="color: #e47980;">(</span>make-point-2d <span style="color: #e3b0c0; font-weight: bold;">:x</span> 100 <span style="color: #e3b0c0; font-weight: bold;">:y</span> 100<span style="color: #e47980;">)</span>
                        <span style="color: #e3b0c0; font-weight: bold;">:width</span> 750
                        <span style="color: #e3b0c0; font-weight: bold;">:height</span> 750<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span>window-add-renderable *win* *axis*<span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span>axis-add-renderable *axis* <span style="color: #80aadf;">(</span>make-plot <span style="color: #e3b0c0; font-weight: bold;">:lam</span> <span style="color: #e47980;">(</span><span style="color: #deb07a; font-weight: bold;">lambda</span> <span style="color: #d0b0ff;">(</span>x<span style="color: #d0b0ff;">)</span> <span style="color: #d0b0ff;">(</span>* x x<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span> <span style="color: #e3b0c0; font-weight: bold;">:min-x</span> -2 <span style="color: #e3b0c0; font-weight: bold;">:max-x</span> 1<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">(axis-add-renderable *axis* (make-plot :lam (lambda (x) (sin x)) :min-x -2 :max-x 1))</span>
  <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">(axis-add-renderable *axis* (make-plot :lam (lambda (x) (tan x)) :min-x -2 :max-x 1))</span>
  <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">(axis-add-renderable *axis* (make-plot :lam (lambda (x) (cos x)) :min-x -2 :max-x 1))</span>
  <span style="color: #ffaacf;">(</span>axis-add-renderable
   *axis*
   <span style="color: #80aadf;">(</span>make-discrete-plot <span style="color: #e3b0c0; font-weight: bold;">:points</span>
                       <span style="color: #e47980;">(</span>list <span style="color: #d0b0ff;">(</span>make-point-2d <span style="color: #e3b0c0; font-weight: bold;">:x</span> -1 <span style="color: #e3b0c0; font-weight: bold;">:y</span> 1<span style="color: #d0b0ff;">)</span>
                             <span style="color: #d0b0ff;">(</span>make-point-2d <span style="color: #e3b0c0; font-weight: bold;">:x</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:y</span> 0<span style="color: #d0b0ff;">)</span>
                             <span style="color: #d0b0ff;">(</span>make-point-2d <span style="color: #e3b0c0; font-weight: bold;">:x</span> 2 <span style="color: #e3b0c0; font-weight: bold;">:y</span> 1<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span>sb-thread:make-thread <span style="color: #80aadf;">(</span><span style="color: #deb07a; font-weight: bold;">lambda</span> <span style="color: #e47980;">()</span> <span style="color: #e47980;">(</span>window-run *win*<span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>
</pre>
</div>

<p>
we can create objects and add them dynamically to the window:
</p>
<div class="org-src-container" data-language="lisp">
<pre class="src src-lisp"><span style="color: #deb07a;">(</span>window-add-renderable
 *win*
 <span style="color: #ffaacf;">(</span>make-discrete-plot <span style="color: #e3b0c0; font-weight: bold;">:points</span>
                     <span style="color: #80aadf;">(</span>list <span style="color: #e47980;">(</span>make-point-2d <span style="color: #e3b0c0; font-weight: bold;">:x</span> <span style="color: #d0b0ff;">(</span>/ <span style="color: #3fc489;">(</span>random 10<span style="color: #3fc489;">)</span> 10<span style="color: #d0b0ff;">)</span> <span style="color: #e3b0c0; font-weight: bold;">:y</span> <span style="color: #d0b0ff;">(</span>/ <span style="color: #3fc489;">(</span>random 10<span style="color: #3fc489;">)</span> 10<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
                           <span style="color: #e47980;">(</span>make-point-2d <span style="color: #e3b0c0; font-weight: bold;">:x</span> <span style="color: #d0b0ff;">(</span>/ <span style="color: #3fc489;">(</span>random 10<span style="color: #3fc489;">)</span> 10<span style="color: #d0b0ff;">)</span> <span style="color: #e3b0c0; font-weight: bold;">:y</span> <span style="color: #d0b0ff;">(</span>/ <span style="color: #3fc489;">(</span>random 10<span style="color: #3fc489;">)</span> 10<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>
</pre>
</div>

<p>
rendering text wasnt as simple as i expected, i ended up using <b>freetype</b> because thats what most webpages seemed to promote. the library <code>cl-freetype2</code> provides freetype bindings for sbcl, example usage is here <a href="https://github.com/rpav/cl-freetype2/blob/master/doc/example.md">https://github.com/rpav/cl-freetype2/blob/master/doc/example.md</a>
</p>
<div class="org-src-container" data-language="lisp">
<pre class="src src-lisp"><span style="color: #deb07a;">(</span>ql:quickload <span style="color: #e3b0c0; font-weight: bold;">:cl-freetype2</span><span style="color: #deb07a;">)</span>
</pre>
</div>

<p>
toy around with it to make sure it works:
</p>
<div class="org-src-container" data-language="lisp">
<pre class="src src-lisp"><span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">make sure your encoding is set to UTF-8</span>
<span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">load font, change according to your system, im on linux</span>
<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defparameter</span> <span style="color: #ffaacf;">*face*</span> <span style="color: #ffaacf;">(</span>freetype2:new-face <span style="color: #f3a0a0;">"/usr/share/fonts/TTF/CascadiaCode.ttf"</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>
<span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">Set the size to 24 points and 36 DPI</span>
<span style="color: #deb07a;">(</span>freetype2:set-char-size *face* <span style="color: #ffaacf;">(</span>* 24 64<span style="color: #ffaacf;">)</span> 0 36 36<span style="color: #deb07a;">)</span>
<span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">trivial output:</span>
<span style="color: #deb07a;">(</span>freetype2:print-with-face *face* <span style="color: #f3a0a0;">"Hello"</span><span style="color: #deb07a;">)</span>
<span style="color: #deb07a;">(</span>ft2:get-char-index *face* #\a<span style="color: #deb07a;">)</span>
<span style="color: #deb07a;">(</span>ft2:load-char *face* #\A<span style="color: #deb07a;">)</span>
<span style="color: #deb07a;">(</span>ft2:render-glyph *face*<span style="color: #deb07a;">)</span>
<span style="color: #deb07a;">(</span>ft2:do-string-render <span style="color: #ffaacf;">(</span>*face* <span style="color: #f3a0a0;">"o"</span> bitmap x y<span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span>print <span style="color: #80aadf;">(</span>ft2:bitmap-to-array bitmap<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>
</pre>
</div>

<p>
it was hard to figure things out as this was my first time rendering text at such a low level and couldnt find proper documentation for <code>cl-freetype2</code>, had to browse through the source code
i tried to adapt the code from <a href="http://3bb.cc/tutorials/cl-opengl/textures.html">http://3bb.cc/tutorials/cl-opengl/textures.html</a>:
</p>
<div class="org-src-container" data-language="lisp">
<pre class="src src-lisp"><span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defstruct</span> <span style="color: #a9c99f;">renderable-text</span> <span style="color: #ffaacf;">()</span>
  text pos <span style="color: #ffaacf;">(</span>color <span style="color: #80aadf;">(</span>make-rgb <span style="color: #e3b0c0; font-weight: bold;">:r</span> 255 <span style="color: #e3b0c0; font-weight: bold;">:b</span> 255 <span style="color: #e3b0c0; font-weight: bold;">:g</span> 255<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">render</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>txt renderable-text<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">Render text using FreeType2</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">let</span> <span style="color: #80aadf;">(</span><span style="color: #e47980;">(</span>face <span style="color: #d0b0ff;">(</span>freetype2:new-face <span style="color: #f3a0a0;">"/usr/share/fonts/TTF/CascadiaCode.ttf"</span><span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
        <span style="color: #e47980;">(</span>text <span style="color: #d0b0ff;">(</span>renderable-text-text txt<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
        <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">(x (point-2d-x (renderable-text-pos txt)))</span>
        <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">(y (point-2d-y (renderable-text-pos txt)))</span>
        <span style="color: #e47980;">(</span>texture <span style="color: #d0b0ff;">(</span>car <span style="color: #3fc489;">(</span>gl:gen-textures 1<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span>freetype2:set-char-size face <span style="color: #e47980;">(</span>* 48 64<span style="color: #e47980;">)</span> 0 36 36<span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span>gl:enable <span style="color: #e3b0c0; font-weight: bold;">:texture-2d</span><span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span>gl:bind-texture <span style="color: #e3b0c0; font-weight: bold;">:texture-2d</span> texture<span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span>gl:tex-parameter <span style="color: #e3b0c0; font-weight: bold;">:texture-2d</span> <span style="color: #e3b0c0; font-weight: bold;">:texture-min-filter</span> <span style="color: #e3b0c0; font-weight: bold;">:linear</span><span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span>gl:color 1 1 1<span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span>ft2:do-string-render <span style="color: #e47980;">(</span>face <span style="color: #f3a0a0;">"l"</span> bitmap x y<span style="color: #e47980;">)</span>
      <span style="color: #e47980;">(</span><span style="color: #deb07a; font-weight: bold;">let</span> <span style="color: #d0b0ff;">(</span><span style="color: #3fc489;">(</span>gray-colored-pixels <span style="color: #6fb3c0;">(</span>list-&gt;vector <span style="color: #c0b24f;">(</span>apply #'concatenate <span style="color: #f3a0a0;">(</span>append '<span style="color: #deb07a;">(</span>list<span style="color: #deb07a;">)</span> <span style="color: #deb07a;">(</span>array-&gt;list <span style="color: #ffaacf;">(</span>ft2:bitmap-to-array bitmap<span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span><span style="color: #f3a0a0;">)</span><span style="color: #c0b24f;">)</span><span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span>
        <span style="color: #d0b0ff;">(</span>gl:tex-image-2d <span style="color: #e3b0c0; font-weight: bold;">:texture-2d</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:luminance</span> 64 64 0 <span style="color: #e3b0c0; font-weight: bold;">:luminance</span> <span style="color: #e3b0c0; font-weight: bold;">:unsigned-byte</span> gray-colored-pixels<span style="color: #d0b0ff;">)</span>
        <span style="color: #e47980;">)</span>
      <span style="color: #e47980;">(</span>gl:with-primitives <span style="color: #e3b0c0; font-weight: bold;">:quads</span>
        <span style="color: #d0b0ff;">(</span>gl:tex-coord 0 0<span style="color: #d0b0ff;">)</span>
        <span style="color: #d0b0ff;">(</span>gl:vertex -1 1<span style="color: #d0b0ff;">)</span>
        <span style="color: #d0b0ff;">(</span>gl:tex-coord 1 0<span style="color: #d0b0ff;">)</span>
        <span style="color: #d0b0ff;">(</span>gl:vertex 0 1<span style="color: #d0b0ff;">)</span>
        <span style="color: #d0b0ff;">(</span>gl:tex-coord 1 1<span style="color: #d0b0ff;">)</span>
        <span style="color: #d0b0ff;">(</span>gl:vertex 0 0<span style="color: #d0b0ff;">)</span>
        <span style="color: #d0b0ff;">(</span>gl:tex-coord 0 1<span style="color: #d0b0ff;">)</span>
        <span style="color: #d0b0ff;">(</span>gl:vertex -1 0<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span>gl:delete-textures <span style="color: #e47980;">(</span>list texture<span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defun</span> <span style="color: #8fcfd0;">freetype-test</span> <span style="color: #ffaacf;">()</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">defparameter</span> <span style="color: #ffaacf;">*win*</span> <span style="color: #80aadf;">(</span>make-instance 'window <span style="color: #e3b0c0; font-weight: bold;">:draw-axis</span> t <span style="color: #e3b0c0; font-weight: bold;">:width</span> 750 <span style="color: #e3b0c0; font-weight: bold;">:height</span> 750<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span>window-add-renderable *win* <span style="color: #80aadf;">(</span>make-renderable-text
                                <span style="color: #e3b0c0; font-weight: bold;">:text</span> <span style="color: #f3a0a0;">"hello"</span>
                                <span style="color: #e3b0c0; font-weight: bold;">:pos</span> <span style="color: #e47980;">(</span>make-point-2d <span style="color: #e3b0c0; font-weight: bold;">:x</span> 10 <span style="color: #e3b0c0; font-weight: bold;">:y</span> 10<span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span>window-run *win*<span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>
</pre>
</div>

<p>
couldn't get this to work so i gave up and decided to use raylib since it provides more features than sdl2 (on its own, for example sdl2 doesnt have a way to draw a line with a specific thickness) and i wouldnt even have to deal with opengl
</p>
<div id="outline-container-org6403a7d" class="outline-2">
<h2 id="org6403a7d">cl-raylib</h2>
<div class="outline-text-2" id="text-org6403a7d">
<p>
on <code>arch linux</code> had to install it using <code>pacman</code> (<code>raylib</code>)
<code>cl-raylib</code> is currently not on quicklist so you gotta fetch it manually:
</p>
<div class="org-src-container" data-language="bash">
<pre class="src src-bash">git clone https://github.com/longlene/cl-raylib.git ~/.quicklisp/local-projects/cl-raylib
</pre>
</div>

<div class="org-src-container" data-language="lisp">
<pre class="src src-lisp"><span style="color: #deb07a;">(</span>ql:quickload <span style="color: #e3b0c0; font-weight: bold;">:cl-raylib</span><span style="color: #deb07a;">)</span>
<span style="color: #deb07a;">(</span>ql:quickload <span style="color: #e3b0c0; font-weight: bold;">:3d-vectors</span><span style="color: #deb07a;">)</span> <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">we need this library to work with cl-raylib..</span>
</pre>
</div>

<p>
its pretty simple to get started with:
</p>
<div class="org-src-container" data-language="lisp">
<pre class="src src-lisp"><span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defun</span> <span style="color: #8fcfd0;">raylib-first-test</span> <span style="color: #ffaacf;">()</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">let</span> <span style="color: #80aadf;">(</span><span style="color: #e47980;">(</span>screen-width 800<span style="color: #e47980;">)</span>
        <span style="color: #e47980;">(</span>screen-height 450<span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span>raylib:with-window <span style="color: #e47980;">(</span>screen-width screen-height <span style="color: #f3a0a0;">"raylib [core] example - basic window"</span><span style="color: #e47980;">)</span>
      <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">(raylib:set-target-fps 60)</span>
      <span style="color: #e47980;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span>
        until <span style="color: #d0b0ff;">(</span>raylib:window-should-close<span style="color: #d0b0ff;">)</span> <span style="color: #a0a0cf; font-style: italic;">; dectect window close button or ESC key</span>
        do <span style="color: #d0b0ff;">(</span>raylib:with-drawing
             <span style="color: #3fc489;">(</span>raylib:clear-background raylib:+raywhite+<span style="color: #3fc489;">)</span>
             <span style="color: #3fc489;">(</span>raylib:draw-fps 20 20<span style="color: #3fc489;">)</span>
             <span style="color: #3fc489;">(</span>raylib:draw-text <span style="color: #f3a0a0;">"Congrats! You created your first window!"</span> 190 200 20 raylib:+lightgray+<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>
</pre>
</div>

<p>
we need some way to say whether an object is renderable or not, to discriminate renderable objects and prevent an attempt to render other objects, we use cl's <code>defgeneric</code> and construct some basic renderable types:
</p>
<div class="org-src-container" data-language="lisp">
<pre class="src src-lisp"><span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defstruct</span> <span style="color: #a9c99f;">rgb</span>
  <span style="color: #caa89f; font-style: italic;">"rgb color"</span>
  <span style="color: #ffaacf;">(</span>r 0<span style="color: #ffaacf;">)</span> <span style="color: #ffaacf;">(</span>g 0<span style="color: #ffaacf;">)</span> <span style="color: #ffaacf;">(</span>b 0<span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defstruct</span> <span style="color: #a9c99f;">point-2d</span> <span style="color: #ffaacf;">()</span>
  x y <span style="color: #ffaacf;">(</span>color <span style="color: #80aadf;">(</span>make-rgb <span style="color: #e3b0c0; font-weight: bold;">:r</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:b</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:g</span> 0<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defstruct</span> <span style="color: #a9c99f;">line-2d</span>
  p1 p2 <span style="color: #ffaacf;">(</span>color <span style="color: #80aadf;">(</span>make-rgb <span style="color: #e3b0c0; font-weight: bold;">:r</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:b</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:g</span> 0<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span> <span style="color: #ffaacf;">(</span>width 1.0<span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>
</pre>
</div>

<div class="org-src-container" data-language="lisp">
<pre class="src src-lisp"><span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defgeneric</span> <span style="color: #8fcfd0;">render</span> <span style="color: #ffaacf;">(</span>obj<span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span><span style="color: #e3b0c0; font-weight: bold;">:documentation</span> <span style="color: #caa89f; font-style: italic;">"a function to render an object"</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">render</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>p point-2d<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span>raylib:draw-pixel <span style="color: #80aadf;">(</span>point-2d-x p<span style="color: #80aadf;">)</span> <span style="color: #80aadf;">(</span>point-2d-y p<span style="color: #80aadf;">)</span>
                     <span style="color: #80aadf;">(</span>raylib:make-rgba
                      <span style="color: #e47980;">(</span>rgb-r <span style="color: #d0b0ff;">(</span>point-2d-color p<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
                      <span style="color: #e47980;">(</span>rgb-g <span style="color: #d0b0ff;">(</span>point-2d-color p<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
                      <span style="color: #e47980;">(</span>rgb-b <span style="color: #d0b0ff;">(</span>point-2d-color p<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">render</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>line line-2d<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">with-slots</span> <span style="color: #80aadf;">(</span>p1 p2 color width<span style="color: #80aadf;">)</span> line
    <span style="color: #80aadf;">(</span>raylib:draw-line-ex
     <span style="color: #e47980;">(</span>3d-vectors:vec <span style="color: #d0b0ff;">(</span>point-2d-x p1<span style="color: #d0b0ff;">)</span> <span style="color: #d0b0ff;">(</span>point-2d-y p1<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
     <span style="color: #e47980;">(</span>3d-vectors:vec <span style="color: #d0b0ff;">(</span>point-2d-x p2<span style="color: #d0b0ff;">)</span> <span style="color: #d0b0ff;">(</span>point-2d-y p2<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
     <span style="color: #e47980;">(</span>float width<span style="color: #e47980;">)</span>
     <span style="color: #e47980;">(</span>raylib:make-rgba
      <span style="color: #d0b0ff;">(</span>rgb-r color<span style="color: #d0b0ff;">)</span>
      <span style="color: #d0b0ff;">(</span>rgb-g color<span style="color: #d0b0ff;">)</span>
      <span style="color: #d0b0ff;">(</span>rgb-b color<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>
</pre>
</div>

<p>
we present the basic code for opening a window and drawing to it:
</p>
<div class="org-src-container" data-language="lisp">
<pre class="src src-lisp"><span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defclass</span> <span style="color: #a9c99f;">window</span> <span style="color: #ffaacf;">()</span>
  <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>renderables <span style="color: #e3b0c0; font-weight: bold;">:initform</span> '<span style="color: #e47980;">()</span> <span style="color: #e3b0c0; font-weight: bold;">:accessor</span> window-renderables<span style="color: #80aadf;">)</span>
   <span style="color: #80aadf;">(</span>width <span style="color: #e3b0c0; font-weight: bold;">:initarg</span> <span style="color: #e3b0c0; font-weight: bold;">:width</span> <span style="color: #e3b0c0; font-weight: bold;">:initform</span> 750 <span style="color: #e3b0c0; font-weight: bold;">:accessor</span> window-width<span style="color: #80aadf;">)</span>
   <span style="color: #80aadf;">(</span>height <span style="color: #e3b0c0; font-weight: bold;">:initarg</span> <span style="color: #e3b0c0; font-weight: bold;">:height</span> <span style="color: #e3b0c0; font-weight: bold;">:initform</span> 750 <span style="color: #e3b0c0; font-weight: bold;">:accessor</span> window-height<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">window-run</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>win window<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">let</span> <span style="color: #80aadf;">(</span><span style="color: #e47980;">(</span>my-should-close nil<span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span><span style="color: #deb07a; font-weight: bold;">with-slots</span> <span style="color: #e47980;">(</span>width height<span style="color: #e47980;">)</span> win
      <span style="color: #e47980;">(</span>raylib:with-window <span style="color: #d0b0ff;">(</span>width height <span style="color: #f3a0a0;">"test window"</span><span style="color: #d0b0ff;">)</span>
        <span style="color: #d0b0ff;">(</span>raylib:set-target-fps 60<span style="color: #d0b0ff;">)</span>
        <span style="color: #d0b0ff;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span>
          until my-should-close <span style="color: #a0a0cf; font-style: italic;">;;</span><span style="color: #a0a0cf; font-style: italic;">(or (raylib:window-should-close) my-should-close)</span>
          do <span style="color: #3fc489;">(</span>raylib:with-drawing
               <span style="color: #6fb3c0;">(</span>raylib:clear-background raylib:+raywhite+<span style="color: #6fb3c0;">)</span>
               <span style="color: #6fb3c0;">(</span>livesupport:update-repl-link<span style="color: #6fb3c0;">)</span> <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">accept requests from slime/sly, for live programming</span>
               <span style="color: #6fb3c0;">(</span>livesupport:continuable <span style="color: #c0b24f;">(</span>window-render win<span style="color: #c0b24f;">)</span><span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span>
               <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">(raylib:draw-fps 20 20)</span>
             <span style="color: #3fc489;">(</span><span style="color: #deb07a; font-weight: bold;">when</span> <span style="color: #6fb3c0;">(</span>raylib:is-key-pressed <span style="color: #e3b0c0; font-weight: bold;">:key-q</span><span style="color: #6fb3c0;">)</span>
               <span style="color: #6fb3c0;">(</span>setf my-should-close t<span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span>
          <span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">window-render</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>win window<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #caa89f; font-style: italic;">"render the renderables"</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span> for renderable in <span style="color: #80aadf;">(</span>window-renderables win<span style="color: #80aadf;">)</span>
        do <span style="color: #80aadf;">(</span>render renderable<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">window-add-renderable</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>win window<span style="color: #80aadf;">)</span> renderable<span style="color: #ffaacf;">)</span>
  <span style="color: #caa89f; font-style: italic;">"add a renderable to renderables, a renderable is an object that has the generic function render"</span>
  <span style="color: #ffaacf;">(</span>push renderable <span style="color: #80aadf;">(</span>window-renderables win<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>
</pre>
</div>

<p>
example usage:
</p>
<div class="org-src-container" data-language="lisp">
<pre class="src src-lisp"><span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defun</span> <span style="color: #8fcfd0;">raylib-second-test</span> <span style="color: #ffaacf;">()</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">defparameter</span> <span style="color: #ffaacf;">*win*</span> <span style="color: #80aadf;">(</span>make-instance 'window <span style="color: #e3b0c0; font-weight: bold;">:width</span> 750 <span style="color: #e3b0c0; font-weight: bold;">:height</span> 750<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span>window-add-renderable *win*
                         <span style="color: #80aadf;">(</span>make-line-2d <span style="color: #e3b0c0; font-weight: bold;">:p1</span> <span style="color: #e47980;">(</span>make-point-2d <span style="color: #e3b0c0; font-weight: bold;">:x</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:y</span> 0<span style="color: #e47980;">)</span>
                                       <span style="color: #e3b0c0; font-weight: bold;">:p2</span> <span style="color: #e47980;">(</span>make-point-2d <span style="color: #e3b0c0; font-weight: bold;">:x</span> 300 <span style="color: #e3b0c0; font-weight: bold;">:y</span> 300<span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span>window-run *win*<span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>
</pre>
</div>

<p>
we need to implement math plotting functionality, but..
</p>

<p>
unfortunately raylib doesnt allow matrix manipulation (atleast for 2d cameras)
i had to figure out an easy way to allow objects to render themselves to a normalized screen space, for example we might want to draw a mathematical function from x=0 to x=10, and y might vary from 0-100 if the function was <?xml version='1.0' encoding='UTF-8'?>

<svg version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' viewBox='0 -6.273719 34.182118 8.210901' style="max-height: 0.9061em; vertical-align: -0.2397em; display: inline-block" class="org-latex org-latex-inline">
<defs>
<path id='g1-48' d='m4.582814-3.188045c0-.797011-.049813-1.594022-.398506-2.331258c-.458281-.956413-1.275218-1.115816-1.693649-1.115816c-.597758 0-1.325031 .259029-1.733499 1.185554c-.318804 .687422-.368618 1.464508-.368618 2.261519c0 .747198 .039851 1.643836 .448319 2.400996c.428394 .806974 1.155666 1.006227 1.643836 1.006227c.537983 0 1.295143-.209215 1.733499-1.155666c.318804-.687422 .368618-1.464508 .368618-2.251557zm-.826899-.119552c0 .747198 0 1.424658-.109589 2.062267c-.14944 .946451-.71731 1.24533-1.165629 1.24533c-.388543 0-.976339-.249066-1.155666-1.205479c-.109589-.597758-.109589-1.514321-.109589-2.102117c0-.637609 0-1.295143 .079701-1.833126c.18929-1.185554 .936488-1.275218 1.185554-1.275218c.328767 0 .986301 .179328 1.175592 1.165629c.099626 .557908 .099626 1.315068 .099626 1.942715z'/>
<path id='g1-49' d='m4.174346 0v-.308842h-.318804c-.896638 0-.926526-.109589-.926526-.478207v-5.589041c0-.239103 0-.259029-.229141-.259029c-.617684 .637609-1.494396 .637609-1.8132 .637609v.308842c.199253 0 .787049 0 1.305106-.259029v5.160648c0 .358655-.029888 .478207-.926526 .478207h-.318804v.308842c.348692-.029888 1.215442-.029888 1.613948-.029888s1.265255 0 1.613948 .029888z'/>
<path id='g1-61' d='m7.183064-3.457036c0-.199253-.18929-.199253-.328767-.199253h-5.967621c-.139477 0-.328767 0-.328767 .199253s.18929 .199253 .33873 .199253h5.947696c.14944 0 .33873 0 .33873-.199253zm0 1.932752c0-.199253-.18929-.199253-.33873-.199253h-5.947696c-.14944 0-.33873 0-.33873 .199253s.18929 .199253 .328767 .199253h5.967621c.139477 0 .328767 0 .328767-.199253z'/>
<path id='g0-120' d='m4.941469-1.424658c0-.099626-.089664-.099626-.119552-.099626c-.089664 0-.109589 .039851-.129514 .109589c-.328767 1.066002-1.006227 1.305106-1.325031 1.305106c-.388543 0-.547945-.318804-.547945-.657534c0-.219178 .059776-.438356 .169365-.876712l.33873-1.364882c.059776-.259029 .288917-1.175592 .986301-1.175592c.049813 0 .288917 0 .498132 .129514c-.278954 .049813-.478207 .298879-.478207 .537983c0 .159402 .109589 .348692 .37858 .348692c.219178 0 .537983-.179328 .537983-.577833c0-.518057-.587796-.657534-.926526-.657534c-.577833 0-.926526 .52802-1.046077 .757161c-.249066-.657534-.787049-.757161-1.075965-.757161c-1.036115 0-1.603985 1.285181-1.603985 1.534247c0 .099626 .119552 .099626 .119552 .099626c.079701 0 .109589-.019925 .129514-.109589c.33873-1.05604 .996264-1.305106 1.334994-1.305106c.18929 0 .537983 .089664 .537983 .667497c0 .308842-.169365 .976339-.537983 2.371108c-.159402 .617684-.508095 1.036115-.946451 1.036115c-.059776 0-.288917 0-.498132-.129514c.249066-.049813 .468244-.259029 .468244-.537983c0-.268991-.219178-.348692-.368618-.348692c-.298879 0-.547945 .259029-.547945 .577833c0 .458281 .498132 .657534 .936488 .657534c.657534 0 1.016189-.697385 1.046077-.757161c.119552 .368618 .478207 .757161 1.075965 .757161c1.026152 0 1.594022-1.285181 1.594022-1.534247z'/>
<path id='g0-121' d='m4.841843-3.795766c.039851-.139477 .039851-.159402 .039851-.229141c0-.179328-.139477-.268991-.288917-.268991c-.099626 0-.259029 .059776-.348692 .209215c-.019925 .049813-.099626 .358655-.139477 .537983l-.199253 .797011l-.448319 1.793275c-.039851 .14944-.468244 .846824-1.125778 .846824c-.508095 0-.617684-.438356-.617684-.806974c0-.458281 .169365-1.075965 .508095-1.952677c.159402-.408468 .199253-.518057 .199253-.71731c0-.448319-.318804-.816936-.816936-.816936c-.946451 0-1.315068 1.444583-1.315068 1.534247c0 .099626 .119552 .099626 .119552 .099626c.099626 0 .109589-.019925 .159402-.179328c.268991-.936488 .667497-1.235367 1.006227-1.235367c.079701 0 .249066 0 .249066 .318804c0 .249066-.099626 .508095-.169365 .697385c-.398506 1.05604-.577833 1.62391-.577833 2.092154c0 .886675 .627646 1.185554 1.215442 1.185554c.388543 0 .727273-.169365 1.006227-.448319c-.129514 .518057-.249066 1.006227-.647572 1.534247c-.259029 .33873-.637609 .627646-1.09589 .627646c-.139477 0-.587796-.029888-.757161-.418431c.159402 0 .288917 0 .428394-.119552c.099626-.089664 .199253-.219178 .199253-.408468c0-.308842-.268991-.348692-.368618-.348692c-.229141 0-.557908 .159402-.557908 .647572c0 .498132 .438356 .86675 1.05604 .86675c1.026152 0 2.052304-.9066 2.331258-2.032379l.956413-3.805729z'/>
</defs>
<g id='page1'>
<g fill='currentColor'>
<use x='0' y='0' xlink:href='#g0-121'/>
<use x='8.009276' y='0' xlink:href='#g1-61'/>
<use x='18.525546' y='0' xlink:href='#g1-49'/>
<use x='23.506866' y='0' xlink:href='#g1-48'/>
<use x='28.488186' y='0' xlink:href='#g0-120'/>
</g>
</g>
</svg>, but in raylib's window 0,0 is at the top left and y increases as we go down the window, we need some sort of <b>normalization</b>, it is fairly easy to implement a normalization function/matrix, but consider an axes object with many math functions, how would the functions know where the axis' 0,0 point is? they'd have to have a reference of the axis object, but it doesnt make much sense for them to have a pointer to their parent, in opengl this was possible because the parent was able to manipulate its viewport and its rendering matrix and then let its children draw themselves to a normalized portion of the window, as far as i can tell, raylib doesnt provide such functionality by default, so i had to come up with something, and thought about using a <a href="/common_lisp.html">macro</a> (eventually settled on a different approach, explained below), perhaps call it <code>with-normalization</code>, that takes a normalization function, code to execute, modifies every call to a point's <code>x</code> and <code>y</code> and normalizes it before it is passed to raylib rendering functions, lets see how well that goes
so basically we want the accessors of the <code>point-2d</code> class to behave differently inside our macro, which begs the question, is that even possible? can we have it so that a specific function behaves differently inside a macro? my first guess was i could modify the <code>body</code> passed to a macro to wrap the calls to <code>point-2d-x</code> and <code>point-2d-y</code> with another function, this would introduce some problems, but then i found out anaphoric macro, so that's what im gonna use
consider the following macro:
</p>
<div class="org-src-container" data-language="lisp">
<pre class="src src-lisp"><span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmacro</span> <span style="color: #8fcfd0;">with-normalization</span> <span style="color: #ffaacf;">(</span><span style="color: #a9c99f;">&amp;body</span> body<span style="color: #ffaacf;">)</span>
  `<span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">flet</span> <span style="color: #80aadf;">(</span><span style="color: #e47980;">(</span>point-2d-x <span style="color: #d0b0ff;">(</span>p<span style="color: #d0b0ff;">)</span> <span style="color: #d0b0ff;">(</span>/ <span style="color: #3fc489;">(</span>point-2d-x p<span style="color: #3fc489;">)</span> 10<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span>
     ,@body<span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>
</pre>
</div>

<p>
in the simple case it works fine but not in others:
</p>
<div class="org-src-container" data-language="lisp">
<pre class="src src-lisp">CL-USER&gt; <span style="color: #deb07a;">(</span>setf a <span style="color: #ffaacf;">(</span>make-point-2d <span style="color: #e3b0c0; font-weight: bold;">:x</span> 10 <span style="color: #e3b0c0; font-weight: bold;">:y</span> 10<span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>
#S<span style="color: #deb07a;">(</span>POINT-2D <span style="color: #e3b0c0; font-weight: bold;">:NIL</span> NIL <span style="color: #e3b0c0; font-weight: bold;">:X</span> 10 <span style="color: #e3b0c0; font-weight: bold;">:Y</span> 10 <span style="color: #e3b0c0; font-weight: bold;">:COLOR</span> #S<span style="color: #ffaacf;">(</span>RGB <span style="color: #e3b0c0; font-weight: bold;">:R</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:G</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:B</span> 0<span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>
CL-USER&gt; <span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">with-normalization</span> a<span style="color: #deb07a;">)</span>
#S<span style="color: #deb07a;">(</span>POINT-2D <span style="color: #e3b0c0; font-weight: bold;">:NIL</span> NIL <span style="color: #e3b0c0; font-weight: bold;">:X</span> 10 <span style="color: #e3b0c0; font-weight: bold;">:Y</span> 10 <span style="color: #e3b0c0; font-weight: bold;">:COLOR</span> #S<span style="color: #ffaacf;">(</span>RGB <span style="color: #e3b0c0; font-weight: bold;">:R</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:G</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:B</span> 0<span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>
CL-USER&gt; <span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">with-normalization</span> <span style="color: #ffaacf;">(</span>point-2d-x a<span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>
1 <span style="color: #deb07a;">(</span>1 bit, #x1, #o1, #b1<span style="color: #deb07a;">)</span>
CL-USER&gt; <span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">with-normalization</span> <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">with-normalization</span> <span style="color: #80aadf;">(</span>point-2d-x a<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>
1/10 <span style="color: #deb07a;">(</span>0.1, 10%<span style="color: #deb07a;">)</span>
</pre>
</div>

<p>
this works in a <code>lexical</code> scope, calling an outer function that makes a call to <code>point-2d-x</code> wouldnt work as we want because its not shadowed <code>dynamically</code>
this can be done, but its already ugly as it is and uglier approaches isnt something im looking for
</p>

<p>
so i just decided to pass rendering parameters around, i.e. each function receives a matrix/function that normalizes things and uses that on every object before drawing it, so we modify the generic <code>render</code> function to take a transformation matrix and so we have to rewrite the rendering functions for all renderable types we have, which for now are just a point and a line
</p>
<div class="org-src-container" data-language="lisp">
<pre class="src src-lisp"><span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defgeneric</span> <span style="color: #8fcfd0;">render</span> <span style="color: #ffaacf;">(</span>obj transformation-matrix<span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span><span style="color: #e3b0c0; font-weight: bold;">:documentation</span> <span style="color: #caa89f; font-style: italic;">"a function to render an object using the given transformation matrix"</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">point-2d-transform</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>p point-2d<span style="color: #80aadf;">)</span> transformation-matrix<span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">let*</span> <span style="color: #80aadf;">(</span><span style="color: #e47980;">(</span>x <span style="color: #d0b0ff;">(</span>point-2d-x p<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
         <span style="color: #e47980;">(</span>y <span style="color: #d0b0ff;">(</span>point-2d-y p<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
         <span style="color: #e47980;">(</span>point-as-matrix <span style="color: #d0b0ff;">(</span>list-&gt;array <span style="color: #3fc489;">(</span>map 'list #'list <span style="color: #6fb3c0;">(</span>list x y 1<span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
         <span style="color: #e47980;">(</span>transformed-point-as-matrix <span style="color: #d0b0ff;">(</span>matrix-mul transformation-matrix point-as-matrix<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
         <span style="color: #e47980;">(</span>transformed-point-as-list <span style="color: #d0b0ff;">(</span>array-&gt;list transformed-point-as-matrix<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span>make-point-2d <span style="color: #e3b0c0; font-weight: bold;">:x</span> <span style="color: #e47980;">(</span>car <span style="color: #d0b0ff;">(</span>car transformed-point-as-list<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
                   <span style="color: #e3b0c0; font-weight: bold;">:y</span> <span style="color: #e47980;">(</span>car <span style="color: #d0b0ff;">(</span>car <span style="color: #3fc489;">(</span>cdr transformed-point-as-list<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
                   <span style="color: #e3b0c0; font-weight: bold;">:color</span> <span style="color: #e47980;">(</span>point-2d-color p<span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">render</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>p point-2d<span style="color: #80aadf;">)</span> transformation-matrix<span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">let</span> <span style="color: #80aadf;">(</span><span style="color: #e47980;">(</span>p <span style="color: #d0b0ff;">(</span>point-2d-transform p transformation-matrix<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span>raylib:draw-pixel <span style="color: #e47980;">(</span>round <span style="color: #d0b0ff;">(</span>point-2d-x p<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span> <span style="color: #e47980;">(</span>round <span style="color: #d0b0ff;">(</span>point-2d-y p<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
                       <span style="color: #e47980;">(</span>raylib:make-rgba
                        <span style="color: #d0b0ff;">(</span>rgb-r <span style="color: #3fc489;">(</span>point-2d-color p<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span>
                        <span style="color: #d0b0ff;">(</span>rgb-g <span style="color: #3fc489;">(</span>point-2d-color p<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span>
                        <span style="color: #d0b0ff;">(</span>rgb-b <span style="color: #3fc489;">(</span>point-2d-color p<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">render</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>line line-2d<span style="color: #80aadf;">)</span> transformation-matrix<span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">with-slots</span> <span style="color: #80aadf;">(</span>p1 p2 color width<span style="color: #80aadf;">)</span> line
    <span style="color: #80aadf;">(</span><span style="color: #deb07a; font-weight: bold;">let</span> <span style="color: #e47980;">(</span><span style="color: #d0b0ff;">(</span>p1 <span style="color: #3fc489;">(</span>point-2d-transform p1 transformation-matrix<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span>
          <span style="color: #d0b0ff;">(</span>p2 <span style="color: #3fc489;">(</span>point-2d-transform p2 transformation-matrix<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
      <span style="color: #e47980;">(</span>raylib:draw-line-ex
       <span style="color: #d0b0ff;">(</span>3d-vectors:vec <span style="color: #3fc489;">(</span>point-2d-x p1<span style="color: #3fc489;">)</span> <span style="color: #3fc489;">(</span>point-2d-y p1<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span>
       <span style="color: #d0b0ff;">(</span>3d-vectors:vec <span style="color: #3fc489;">(</span>point-2d-x p2<span style="color: #3fc489;">)</span> <span style="color: #3fc489;">(</span>point-2d-y p2<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span>
       <span style="color: #d0b0ff;">(</span>float width<span style="color: #d0b0ff;">)</span>
       <span style="color: #d0b0ff;">(</span>raylib:make-rgba
        <span style="color: #3fc489;">(</span>rgb-r color<span style="color: #3fc489;">)</span>
        <span style="color: #3fc489;">(</span>rgb-g color<span style="color: #3fc489;">)</span>
        <span style="color: #3fc489;">(</span>rgb-b color<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>
</pre>
</div>

<p>
i wanted a simple way to draw continuous and discrete math functions, so i thought about implementing an <code>axis</code> object first, which would hold these plots and pass the proper transformation matrix to them, plus it would take care of actually rendering the axes on the screen
here im <a href="/2d_transformations.html">linearly mapping grids</a> using the transformation matrix for it
</p>
<div class="org-src-container" data-language="lisp">
<pre class="src src-lisp"><span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defparameter</span> <span style="color: #ffaacf;">*default-transformation-matrix*</span> #2A<span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>1 0 0<span style="color: #80aadf;">)</span> <span style="color: #80aadf;">(</span>0 1 0<span style="color: #80aadf;">)</span> <span style="color: #80aadf;">(</span>0 0 1<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">window-render</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>win window<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #caa89f; font-style: italic;">"render the renderables"</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span> for renderable in <span style="color: #80aadf;">(</span>window-renderables win<span style="color: #80aadf;">)</span>
        do <span style="color: #80aadf;">(</span>render renderable *default-transformation-matrix*<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defstruct</span> <span style="color: #a9c99f;">axis</span>
  <span style="color: #caa89f; font-style: italic;">"a renderable, can hold other renderables which would be drawn locally (transformed), pos is the (point-2d) position in the window"</span>
  <span style="color: #ffaacf;">(</span>renderables '<span style="color: #80aadf;">()</span><span style="color: #ffaacf;">)</span> pos width height <span style="color: #ffaacf;">(</span>color <span style="color: #80aadf;">(</span>make-rgb <span style="color: #e3b0c0; font-weight: bold;">:r</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:b</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:g</span> 0<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">bounds of the axes</span>
  <span style="color: #ffaacf;">(</span>min-y -1<span style="color: #ffaacf;">)</span> <span style="color: #ffaacf;">(</span>max-y 1<span style="color: #ffaacf;">)</span> <span style="color: #ffaacf;">(</span>min-x -1<span style="color: #ffaacf;">)</span> <span style="color: #ffaacf;">(</span>max-x 1<span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">axis-add-renderable</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>a axis<span style="color: #80aadf;">)</span> renderable<span style="color: #ffaacf;">)</span>
  <span style="color: #caa89f; font-style: italic;">"add a renderable to renderables, a renderable is an object that has the generic function render"</span>
  <span style="color: #ffaacf;">(</span>push renderable <span style="color: #80aadf;">(</span>axis-renderables a<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">for some reason text is oddly positioned with an offset, might be related: https://github.com/raysan5/raylib/issues/908</span>
<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defun</span> <span style="color: #8fcfd0;">draw-text</span> <span style="color: #ffaacf;">(</span>text size x y<span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span>raylib:draw-text
   text
   <span style="color: #80aadf;">(</span>round <span style="color: #e47980;">(</span>- x <span style="color: #d0b0ff;">(</span>/ <span style="color: #3fc489;">(</span>raylib:measure-text text size<span style="color: #3fc489;">)</span> 2<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span>
   <span style="color: #80aadf;">(</span>round <span style="color: #e47980;">(</span>+ y <span style="color: #d0b0ff;">(</span>/ <span style="color: #3fc489;">(</span>3d-vectors:vy <span style="color: #6fb3c0;">(</span>raylib:measure-text-ex <span style="color: #c0b24f;">(</span>raylib:get-font-default<span style="color: #c0b24f;">)</span> text <span style="color: #c0b24f;">(</span>float size<span style="color: #c0b24f;">)</span> 1.0<span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span> 2<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span>
   size
   raylib:+black+<span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">render</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>a axis<span style="color: #80aadf;">)</span> transformation-matrix<span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">with-slots</span> <span style="color: #80aadf;">(</span>min-y min-x max-y max-x width height pos<span style="color: #80aadf;">)</span> a
    <span style="color: #80aadf;">(</span><span style="color: #deb07a; font-weight: bold;">let*</span> <span style="color: #e47980;">(</span><span style="color: #d0b0ff;">(</span>pos-x <span style="color: #3fc489;">(</span>point-2d-x pos<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span>
           <span style="color: #d0b0ff;">(</span>pos-y <span style="color: #3fc489;">(</span>point-2d-y pos<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span>
           <span style="color: #d0b0ff;">(</span>children-transformation-matrix
             <span style="color: #3fc489;">(</span>map-grid
              transformation-matrix
              <span style="color: #6fb3c0;">(</span>list min-x max-x<span style="color: #6fb3c0;">)</span>
              <span style="color: #6fb3c0;">(</span>list pos-x <span style="color: #c0b24f;">(</span>+ pos-x width<span style="color: #c0b24f;">)</span><span style="color: #6fb3c0;">)</span>
              <span style="color: #6fb3c0;">(</span>list min-y max-y<span style="color: #6fb3c0;">)</span>
              <span style="color: #6fb3c0;">(</span>list <span style="color: #c0b24f;">(</span>+ pos-y height<span style="color: #c0b24f;">)</span> pos-y<span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span>
           <span style="color: #d0b0ff;">(</span>origin <span style="color: #3fc489;">(</span>point-2d-transform <span style="color: #6fb3c0;">(</span>make-point-2d <span style="color: #e3b0c0; font-weight: bold;">:x</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:y</span> 0<span style="color: #6fb3c0;">)</span> children-transformation-matrix<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span>
           <span style="color: #d0b0ff;">(</span>tick-distance 75<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
      <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">render children (renderables)</span>
      <span style="color: #e47980;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span> for renderable in <span style="color: #d0b0ff;">(</span>axis-renderables a<span style="color: #d0b0ff;">)</span>
            do <span style="color: #d0b0ff;">(</span>render
                renderable
                children-transformation-matrix<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
      <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">draw the ticks on the axes</span>
      <span style="color: #e47980;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span> for x from <span style="color: #d0b0ff;">(</span>point-2d-x origin<span style="color: #d0b0ff;">)</span> below <span style="color: #d0b0ff;">(</span>+ pos-x width<span style="color: #d0b0ff;">)</span> by tick-distance
            do <span style="color: #d0b0ff;">(</span>render
                <span style="color: #3fc489;">(</span>make-line-2d
                 <span style="color: #e3b0c0; font-weight: bold;">:p1</span> <span style="color: #6fb3c0;">(</span>make-point-2d
                      <span style="color: #e3b0c0; font-weight: bold;">:x</span> x <span style="color: #e3b0c0; font-weight: bold;">:y</span> <span style="color: #c0b24f;">(</span>- <span style="color: #f3a0a0;">(</span>point-2d-y origin<span style="color: #f3a0a0;">)</span> 10<span style="color: #c0b24f;">)</span><span style="color: #6fb3c0;">)</span>
                 <span style="color: #e3b0c0; font-weight: bold;">:p2</span> <span style="color: #6fb3c0;">(</span>make-point-2d
                      <span style="color: #e3b0c0; font-weight: bold;">:x</span> x <span style="color: #e3b0c0; font-weight: bold;">:y</span> <span style="color: #c0b24f;">(</span>- <span style="color: #f3a0a0;">(</span>point-2d-y origin<span style="color: #f3a0a0;">)</span> -10<span style="color: #c0b24f;">)</span><span style="color: #6fb3c0;">)</span>
                 <span style="color: #e3b0c0; font-weight: bold;">:width</span> 3<span style="color: #3fc489;">)</span>
                transformation-matrix<span style="color: #d0b0ff;">)</span>
               <span style="color: #d0b0ff;">(</span><span style="color: #deb07a; font-weight: bold;">when</span> <span style="color: #3fc489;">(</span>&gt; x <span style="color: #6fb3c0;">(</span>point-2d-x origin<span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span>
                 <span style="color: #3fc489;">(</span>draw-text
                  <span style="color: #6fb3c0;">(</span>format nil <span style="color: #f3a0a0;">"~,3f"</span> <span style="color: #c0b24f;">(</span>map-num x <span style="color: #f3a0a0;">(</span>point-2d-x origin<span style="color: #f3a0a0;">)</span> <span style="color: #f3a0a0;">(</span>+ pos-x width<span style="color: #f3a0a0;">)</span> 0 max-x<span style="color: #c0b24f;">)</span><span style="color: #6fb3c0;">)</span>
                  20
                  x
                  <span style="color: #6fb3c0;">(</span>- <span style="color: #c0b24f;">(</span>point-2d-y origin<span style="color: #c0b24f;">)</span> -10<span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
      <span style="color: #e47980;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span> for x from <span style="color: #d0b0ff;">(</span>point-2d-x origin<span style="color: #d0b0ff;">)</span> above pos-x by tick-distance
            do <span style="color: #d0b0ff;">(</span>render
                <span style="color: #3fc489;">(</span>make-line-2d
                 <span style="color: #e3b0c0; font-weight: bold;">:p1</span> <span style="color: #6fb3c0;">(</span>make-point-2d
                      <span style="color: #e3b0c0; font-weight: bold;">:x</span> x <span style="color: #e3b0c0; font-weight: bold;">:y</span> <span style="color: #c0b24f;">(</span>- <span style="color: #f3a0a0;">(</span>point-2d-y origin<span style="color: #f3a0a0;">)</span> 10<span style="color: #c0b24f;">)</span><span style="color: #6fb3c0;">)</span>
                 <span style="color: #e3b0c0; font-weight: bold;">:p2</span> <span style="color: #6fb3c0;">(</span>make-point-2d
                      <span style="color: #e3b0c0; font-weight: bold;">:x</span> x <span style="color: #e3b0c0; font-weight: bold;">:y</span> <span style="color: #c0b24f;">(</span>- <span style="color: #f3a0a0;">(</span>point-2d-y origin<span style="color: #f3a0a0;">)</span> -10<span style="color: #c0b24f;">)</span><span style="color: #6fb3c0;">)</span>
                 <span style="color: #e3b0c0; font-weight: bold;">:width</span> 3<span style="color: #3fc489;">)</span>
                transformation-matrix<span style="color: #d0b0ff;">)</span>
               <span style="color: #d0b0ff;">(</span><span style="color: #deb07a; font-weight: bold;">when</span> <span style="color: #3fc489;">(</span>&lt; x <span style="color: #6fb3c0;">(</span>point-2d-x origin<span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span>
                 <span style="color: #3fc489;">(</span>draw-text
                  <span style="color: #6fb3c0;">(</span>format nil <span style="color: #f3a0a0;">"~,3f"</span> <span style="color: #c0b24f;">(</span>map-num x <span style="color: #f3a0a0;">(</span>point-2d-x origin<span style="color: #f3a0a0;">)</span> pos-x 0 min-x<span style="color: #c0b24f;">)</span><span style="color: #6fb3c0;">)</span>
                  20
                  x
                  <span style="color: #6fb3c0;">(</span>- <span style="color: #c0b24f;">(</span>point-2d-y origin<span style="color: #c0b24f;">)</span> -10<span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
      <span style="color: #e47980;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span> for y from <span style="color: #d0b0ff;">(</span>point-2d-y origin<span style="color: #d0b0ff;">)</span> above pos-y by tick-distance
            do <span style="color: #d0b0ff;">(</span>render
                <span style="color: #3fc489;">(</span>make-line-2d
                 <span style="color: #e3b0c0; font-weight: bold;">:p1</span> <span style="color: #6fb3c0;">(</span>make-point-2d
                      <span style="color: #e3b0c0; font-weight: bold;">:x</span> <span style="color: #c0b24f;">(</span>- <span style="color: #f3a0a0;">(</span>point-2d-x origin<span style="color: #f3a0a0;">)</span> 10<span style="color: #c0b24f;">)</span> <span style="color: #e3b0c0; font-weight: bold;">:y</span> y<span style="color: #6fb3c0;">)</span>
                 <span style="color: #e3b0c0; font-weight: bold;">:p2</span> <span style="color: #6fb3c0;">(</span>make-point-2d
                      <span style="color: #e3b0c0; font-weight: bold;">:x</span> <span style="color: #c0b24f;">(</span>- <span style="color: #f3a0a0;">(</span>point-2d-x origin<span style="color: #f3a0a0;">)</span> -10<span style="color: #c0b24f;">)</span> <span style="color: #e3b0c0; font-weight: bold;">:y</span> y<span style="color: #6fb3c0;">)</span>
                 <span style="color: #e3b0c0; font-weight: bold;">:width</span> 3<span style="color: #3fc489;">)</span>
                transformation-matrix<span style="color: #d0b0ff;">)</span>
               <span style="color: #d0b0ff;">(</span><span style="color: #deb07a; font-weight: bold;">when</span> <span style="color: #3fc489;">(</span>&lt; y <span style="color: #6fb3c0;">(</span>point-2d-y origin<span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span>
                 <span style="color: #3fc489;">(</span>draw-text
                  <span style="color: #6fb3c0;">(</span>format nil <span style="color: #f3a0a0;">"~,3f"</span> <span style="color: #c0b24f;">(</span>map-num y <span style="color: #f3a0a0;">(</span>point-2d-y origin<span style="color: #f3a0a0;">)</span> pos-y 0 max-y<span style="color: #c0b24f;">)</span><span style="color: #6fb3c0;">)</span>
                  20
                  <span style="color: #6fb3c0;">(</span>point-2d-x origin<span style="color: #6fb3c0;">)</span>
                  y<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
      <span style="color: #e47980;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span> for y from <span style="color: #d0b0ff;">(</span>point-2d-y origin<span style="color: #d0b0ff;">)</span> below <span style="color: #d0b0ff;">(</span>+ pos-y height<span style="color: #d0b0ff;">)</span> by tick-distance
            do <span style="color: #d0b0ff;">(</span>render
                <span style="color: #3fc489;">(</span>make-line-2d
                 <span style="color: #e3b0c0; font-weight: bold;">:p1</span> <span style="color: #6fb3c0;">(</span>make-point-2d
                      <span style="color: #e3b0c0; font-weight: bold;">:x</span> <span style="color: #c0b24f;">(</span>- <span style="color: #f3a0a0;">(</span>point-2d-x origin<span style="color: #f3a0a0;">)</span> 10<span style="color: #c0b24f;">)</span> <span style="color: #e3b0c0; font-weight: bold;">:y</span> y<span style="color: #6fb3c0;">)</span>
                 <span style="color: #e3b0c0; font-weight: bold;">:p2</span> <span style="color: #6fb3c0;">(</span>make-point-2d
                      <span style="color: #e3b0c0; font-weight: bold;">:x</span> <span style="color: #c0b24f;">(</span>- <span style="color: #f3a0a0;">(</span>point-2d-x origin<span style="color: #f3a0a0;">)</span> -10<span style="color: #c0b24f;">)</span> <span style="color: #e3b0c0; font-weight: bold;">:y</span> y<span style="color: #6fb3c0;">)</span>
                 <span style="color: #e3b0c0; font-weight: bold;">:width</span> 3<span style="color: #3fc489;">)</span>
                transformation-matrix<span style="color: #d0b0ff;">)</span>
               <span style="color: #d0b0ff;">(</span><span style="color: #deb07a; font-weight: bold;">when</span> <span style="color: #3fc489;">(</span>&gt; y <span style="color: #6fb3c0;">(</span>point-2d-y origin<span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span>
                 <span style="color: #3fc489;">(</span>draw-text
                  <span style="color: #6fb3c0;">(</span>format nil <span style="color: #f3a0a0;">"~,3f"</span> <span style="color: #c0b24f;">(</span>map-num y <span style="color: #f3a0a0;">(</span>point-2d-y origin<span style="color: #f3a0a0;">)</span> <span style="color: #f3a0a0;">(</span>+ pos-y height<span style="color: #f3a0a0;">)</span> 0 min-y<span style="color: #c0b24f;">)</span><span style="color: #6fb3c0;">)</span>
                  20
                  <span style="color: #6fb3c0;">(</span>point-2d-x origin<span style="color: #6fb3c0;">)</span>
                  y<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
      <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">draw the axes</span>
      <span style="color: #e47980;">(</span>render
       <span style="color: #d0b0ff;">(</span>make-line-2d
        <span style="color: #e3b0c0; font-weight: bold;">:p1</span> <span style="color: #3fc489;">(</span>make-point-2d
             <span style="color: #e3b0c0; font-weight: bold;">:x</span> min-x <span style="color: #e3b0c0; font-weight: bold;">:y</span> 0<span style="color: #3fc489;">)</span>
        <span style="color: #e3b0c0; font-weight: bold;">:p2</span> <span style="color: #3fc489;">(</span>make-point-2d
             <span style="color: #e3b0c0; font-weight: bold;">:x</span> max-x <span style="color: #e3b0c0; font-weight: bold;">:y</span> 0<span style="color: #3fc489;">)</span>
        <span style="color: #e3b0c0; font-weight: bold;">:width</span> 3<span style="color: #d0b0ff;">)</span>
       children-transformation-matrix<span style="color: #e47980;">)</span>
      <span style="color: #e47980;">(</span>render
       <span style="color: #d0b0ff;">(</span>make-line-2d
        <span style="color: #e3b0c0; font-weight: bold;">:p1</span> <span style="color: #3fc489;">(</span>make-point-2d
             <span style="color: #e3b0c0; font-weight: bold;">:x</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:y</span> max-y<span style="color: #3fc489;">)</span>
        <span style="color: #e3b0c0; font-weight: bold;">:p2</span> <span style="color: #3fc489;">(</span>make-point-2d
             <span style="color: #e3b0c0; font-weight: bold;">:x</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:y</span> min-y<span style="color: #3fc489;">)</span>
        <span style="color: #e3b0c0; font-weight: bold;">:width</span> 3<span style="color: #d0b0ff;">)</span>
       children-transformation-matrix<span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defstruct</span> <span style="color: #a9c99f;">plot</span>
  <span style="color: #caa89f; font-style: italic;">"lam is the lambda function to call with x (should return y)"</span>
  lam
  <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">bounds of the plot (drawing bound of the plots)</span>
  min-y max-y min-x max-x
  <span style="color: #ffaacf;">(</span>color <span style="color: #80aadf;">(</span>make-rgb <span style="color: #e3b0c0; font-weight: bold;">:r</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:b</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:g</span> 0<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defun</span> <span style="color: #8fcfd0;">map-num</span> <span style="color: #ffaacf;">(</span>num src-min src-max dest-min dest-max<span style="color: #ffaacf;">)</span>
  <span style="color: #caa89f; font-style: italic;">"(map-num 0.5 -1 1 -50 50) =&gt; 25.0"</span>
  <span style="color: #ffaacf;">(</span>/ <span style="color: #80aadf;">(</span>- <span style="color: #e47980;">(</span>+ <span style="color: #d0b0ff;">(</span>* <span style="color: #3fc489;">(</span>- num src-min<span style="color: #3fc489;">)</span> <span style="color: #3fc489;">(</span>- dest-max dest-min<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span> <span style="color: #d0b0ff;">(</span>* dest-min src-max<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span> <span style="color: #e47980;">(</span>* dest-min src-min<span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span> <span style="color: #80aadf;">(</span>- src-max src-min<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">render</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>p plot<span style="color: #80aadf;">)</span> transformation-matrix<span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">let</span> <span style="color: #80aadf;">(</span><span style="color: #e47980;">(</span>prev-point nil<span style="color: #e47980;">)</span>
        <span style="color: #e47980;">(</span>lam <span style="color: #d0b0ff;">(</span>plot-lam p<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
        <span style="color: #e47980;">(</span>iterations/2 25<span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span> <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">number of iterations divided by 2</span>
    <span style="color: #80aadf;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span> for x from <span style="color: #e47980;">(</span>- iterations/2<span style="color: #e47980;">)</span> upto iterations/2
          do <span style="color: #e47980;">(</span><span style="color: #deb07a; font-weight: bold;">let*</span> <span style="color: #d0b0ff;">(</span><span style="color: #3fc489;">(</span>x <span style="color: #6fb3c0;">(</span>map-num x <span style="color: #c0b24f;">(</span>- iterations/2<span style="color: #c0b24f;">)</span> iterations/2 <span style="color: #c0b24f;">(</span>plot-min-x p<span style="color: #c0b24f;">)</span> <span style="color: #c0b24f;">(</span>plot-max-x p<span style="color: #c0b24f;">)</span><span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span>
                    <span style="color: #3fc489;">(</span>new-y <span style="color: #6fb3c0;">(</span>funcall lam x<span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span>
                    <span style="color: #3fc489;">(</span>new-point <span style="color: #6fb3c0;">(</span>make-point-2d <span style="color: #e3b0c0; font-weight: bold;">:x</span> x <span style="color: #e3b0c0; font-weight: bold;">:y</span> new-y<span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span>
               <span style="color: #d0b0ff;">(</span><span style="color: #deb07a; font-weight: bold;">if</span> prev-point
                   <span style="color: #3fc489;">(</span>render <span style="color: #6fb3c0;">(</span>make-line-2d
                            <span style="color: #e3b0c0; font-weight: bold;">:p1</span> prev-point
                            <span style="color: #e3b0c0; font-weight: bold;">:p2</span> new-point<span style="color: #6fb3c0;">)</span>
                           transformation-matrix<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span>
               <span style="color: #d0b0ff;">(</span>setf prev-point new-point<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defstruct</span> <span style="color: #a9c99f;">discrete-plot</span>
  <span style="color: #caa89f; font-style: italic;">"a discrete plot, one that connects a finite amount of points (not really the definition of 'discrete')"</span>
  points <span style="color: #ffaacf;">(</span>color <span style="color: #80aadf;">(</span>make-rgb <span style="color: #e3b0c0; font-weight: bold;">:r</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:b</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:g</span> 0<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">render</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>p discrete-plot<span style="color: #80aadf;">)</span> transformation-matrix<span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">let*</span> <span style="color: #80aadf;">(</span><span style="color: #e47980;">(</span>points <span style="color: #d0b0ff;">(</span>discrete-plot-points p<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
         <span style="color: #e47980;">(</span>prev-point <span style="color: #d0b0ff;">(</span>elt points 0<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span> for i from 1 below <span style="color: #e47980;">(</span>length points<span style="color: #e47980;">)</span>
          do <span style="color: #e47980;">(</span><span style="color: #deb07a; font-weight: bold;">let</span> <span style="color: #d0b0ff;">(</span><span style="color: #3fc489;">(</span>new-point <span style="color: #6fb3c0;">(</span>elt points i<span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span>
               <span style="color: #d0b0ff;">(</span>render <span style="color: #3fc489;">(</span>make-line-2d
                        <span style="color: #e3b0c0; font-weight: bold;">:p1</span> prev-point
                        <span style="color: #e3b0c0; font-weight: bold;">:p2</span> new-point<span style="color: #3fc489;">)</span>
                       transformation-matrix<span style="color: #d0b0ff;">)</span>
               <span style="color: #d0b0ff;">(</span>setf prev-point new-point<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>
</pre>
</div>

<p>
example usage:
</p>
<div class="org-src-container" data-language="lisp">
<pre class="src src-lisp"><span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defun</span> <span style="color: #8fcfd0;">raylib-third-test</span> <span style="color: #ffaacf;">()</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">defparameter</span> <span style="color: #ffaacf;">*win*</span> <span style="color: #80aadf;">(</span>make-instance 'window <span style="color: #e3b0c0; font-weight: bold;">:width</span> 750 <span style="color: #e3b0c0; font-weight: bold;">:height</span> 750<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">defparameter</span> <span style="color: #ffaacf;">*axis*</span> <span style="color: #80aadf;">(</span>make-axis
                        <span style="color: #e3b0c0; font-weight: bold;">:min-x</span> -10
                        <span style="color: #e3b0c0; font-weight: bold;">:max-x</span> 10
                        <span style="color: #e3b0c0; font-weight: bold;">:max-y</span> 20
                        <span style="color: #e3b0c0; font-weight: bold;">:min-y</span> -5
                        <span style="color: #e3b0c0; font-weight: bold;">:pos</span> <span style="color: #e47980;">(</span>make-point-2d <span style="color: #e3b0c0; font-weight: bold;">:x</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:y</span> 0<span style="color: #e47980;">)</span>
                        <span style="color: #e3b0c0; font-weight: bold;">:width</span> 750
                        <span style="color: #e3b0c0; font-weight: bold;">:height</span> 750<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span>window-add-renderable *win* *axis*<span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span>axis-add-renderable *axis* <span style="color: #80aadf;">(</span>make-plot <span style="color: #e3b0c0; font-weight: bold;">:lam</span> <span style="color: #e47980;">(</span><span style="color: #deb07a; font-weight: bold;">lambda</span> <span style="color: #d0b0ff;">(</span>x<span style="color: #d0b0ff;">)</span> <span style="color: #d0b0ff;">(</span>* x x<span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span> <span style="color: #e3b0c0; font-weight: bold;">:min-x</span> -10 <span style="color: #e3b0c0; font-weight: bold;">:max-x</span> 10<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">(axis-add-renderable *axis* (make-plot :lam (lambda (x) (sin x)) :min-x -10 :max-x 10))</span>
  <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">(axis-add-renderable *axis* (make-plot :lam (lambda (x) (tan x)) :min-x -10 :max-x 10))</span>
  <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">(axis-add-renderable *axis* (make-plot :lam (lambda (x) (cos x)) :min-x -10 :max-x 10))</span>
  <span style="color: #ffaacf;">(</span>sb-thread:make-thread <span style="color: #80aadf;">(</span><span style="color: #deb07a; font-weight: bold;">lambda</span> <span style="color: #e47980;">()</span> <span style="color: #e47980;">(</span>window-run *win*<span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>
</pre>
</div>

<p>
hmmm, im very tempted to try and visualize the <a href="/mandelbrot.html">mandelbrot</a> now, so lets do it, im thinking about just writing the mandelbrot as a function and map it to every pixel on the screen, maybe the function would return a value in 0-255 that describes how "bright" a point is? and we'd just turn it into an rgb? i think that'd do
</p>
<div class="org-src-container" data-language="lisp">
<pre class="src src-lisp"><span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defun</span> <span style="color: #8fcfd0;">complex-square</span> <span style="color: #ffaacf;">(</span>a b<span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span>values <span style="color: #80aadf;">(</span>- <span style="color: #e47980;">(</span>expt a 2<span style="color: #e47980;">)</span> <span style="color: #e47980;">(</span>expt b 2<span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span> <span style="color: #80aadf;">(</span>* 2 a b<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defun</span> <span style="color: #8fcfd0;">complex-abs</span><span style="color: #ffaacf;">(</span>a b<span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span>sqrt <span style="color: #80aadf;">(</span>+ <span style="color: #e47980;">(</span>expt <span style="color: #d0b0ff;">(</span>abs a<span style="color: #d0b0ff;">)</span> 2<span style="color: #e47980;">)</span> <span style="color: #e47980;">(</span>expt <span style="color: #d0b0ff;">(</span>abs b<span style="color: #d0b0ff;">)</span> 2<span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defun</span> <span style="color: #8fcfd0;">mandelbrot</span> <span style="color: #ffaacf;">(</span>c-a c-b<span style="color: #ffaacf;">)</span>
  <span style="color: #caa89f; font-style: italic;">"a is the real number that lies on the real axis, b is a real number which is the component of the imaginary axis, the function returns a value 0-255 that represents the brightness of the point to be used when drawing it"</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">let</span> <span style="color: #80aadf;">(</span><span style="color: #e47980;">(</span>iterations 20<span style="color: #e47980;">)</span>
        <span style="color: #e47980;">(</span>z-a 0<span style="color: #e47980;">)</span>
        <span style="color: #e47980;">(</span>z-b 0<span style="color: #e47980;">)</span>
        <span style="color: #e47980;">(</span>last-i 0<span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span> for i from 0 below iterations
          do <span style="color: #e47980;">(</span><span style="color: #deb07a; font-weight: bold;">multiple-value-bind</span> <span style="color: #d0b0ff;">(</span>squared-z-a squared-z-b<span style="color: #d0b0ff;">)</span> <span style="color: #d0b0ff;">(</span>complex-square z-a z-b<span style="color: #d0b0ff;">)</span>
               <span style="color: #d0b0ff;">(</span>setf z-a <span style="color: #3fc489;">(</span>+ squared-z-a c-a<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span>
               <span style="color: #d0b0ff;">(</span>setf z-b <span style="color: #3fc489;">(</span>+ squared-z-b c-b<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span>
             <span style="color: #e47980;">(</span>setf last-i i<span style="color: #e47980;">)</span>
             <span style="color: #e47980;">(</span><span style="color: #deb07a; font-weight: bold;">when</span> <span style="color: #d0b0ff;">(</span>&gt; <span style="color: #3fc489;">(</span>complex-abs z-a z-b<span style="color: #3fc489;">)</span> 2<span style="color: #d0b0ff;">)</span>
               <span style="color: #d0b0ff;">(</span><span style="color: #deb07a; font-weight: bold;">return</span><span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span>
    <span style="color: #80aadf;">(</span><span style="color: #deb07a; font-weight: bold;">if</span> <span style="color: #e47980;">(</span>&gt; last-i 5<span style="color: #e47980;">)</span>
        <span style="color: #e47980;">(</span>map-num last-i 10 <span style="color: #d0b0ff;">(</span>1- iterations<span style="color: #d0b0ff;">)</span> 254 0<span style="color: #e47980;">)</span>
        255<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defmethod</span> <span style="color: #8fcfd0;">render</span> <span style="color: #ffaacf;">(</span><span style="color: #80aadf;">(</span>thing <span style="color: #e47980;">(</span>eql <span style="color: #e3b0c0; font-weight: bold;">:mandelbrot</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span> transformation-matrix<span style="color: #ffaacf;">)</span>
  <span style="color: #caa89f; font-style: italic;">"render function specialized for the mandelbrot"</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span> for x from -1.6 below 0.5 by 0.015 <span style="color: #a0a0cf; font-style: italic;">;; </span><span style="color: #a0a0cf; font-style: italic;">some bounds of the mandelbrot i already know smaller than [-2,2]</span>
        do <span style="color: #80aadf;">(</span><span style="color: #deb07a; font-weight: bold;">loop</span> for y from -0.9 below 1 by 0.015
                 do <span style="color: #e47980;">(</span><span style="color: #deb07a; font-weight: bold;">let</span> <span style="color: #d0b0ff;">(</span><span style="color: #3fc489;">(</span>brightness <span style="color: #6fb3c0;">(</span>mandelbrot x y<span style="color: #6fb3c0;">)</span><span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span>
                      <span style="color: #d0b0ff;">(</span><span style="color: #deb07a; font-weight: bold;">when</span> <span style="color: #3fc489;">(</span>&lt; brightness 255<span style="color: #3fc489;">)</span>
                        <span style="color: #3fc489;">(</span>render
                         <span style="color: #6fb3c0;">(</span>make-point-2d <span style="color: #e3b0c0; font-weight: bold;">:x</span> x <span style="color: #e3b0c0; font-weight: bold;">:y</span> y <span style="color: #e3b0c0; font-weight: bold;">:color</span> <span style="color: #c0b24f;">(</span>make-rgb <span style="color: #e3b0c0; font-weight: bold;">:r</span> <span style="color: #f3a0a0;">(</span>round brightness<span style="color: #f3a0a0;">)</span>
                                                                   <span style="color: #e3b0c0; font-weight: bold;">:g</span> <span style="color: #f3a0a0;">(</span>round brightness<span style="color: #f3a0a0;">)</span>
                                                                   <span style="color: #e3b0c0; font-weight: bold;">:b</span> <span style="color: #f3a0a0;">(</span>round brightness<span style="color: #f3a0a0;">)</span><span style="color: #c0b24f;">)</span><span style="color: #6fb3c0;">)</span>
                         transformation-matrix<span style="color: #3fc489;">)</span><span style="color: #d0b0ff;">)</span><span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>

<span style="color: #deb07a;">(</span><span style="color: #deb07a; font-weight: bold;">defun</span> <span style="color: #8fcfd0;">mandelbrot-test</span> <span style="color: #ffaacf;">()</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">defparameter</span> <span style="color: #ffaacf;">*win*</span> <span style="color: #80aadf;">(</span>make-instance 'window <span style="color: #e3b0c0; font-weight: bold;">:width</span> 400 <span style="color: #e3b0c0; font-weight: bold;">:height</span> 400<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span><span style="color: #deb07a; font-weight: bold;">defparameter</span> <span style="color: #ffaacf;">*axis*</span> <span style="color: #80aadf;">(</span>make-axis
                        <span style="color: #e3b0c0; font-weight: bold;">:min-x</span> -2
                        <span style="color: #e3b0c0; font-weight: bold;">:max-x</span> 2
                        <span style="color: #e3b0c0; font-weight: bold;">:max-y</span> 2
                        <span style="color: #e3b0c0; font-weight: bold;">:min-y</span> -2
                        <span style="color: #e3b0c0; font-weight: bold;">:pos</span> <span style="color: #e47980;">(</span>make-point-2d <span style="color: #e3b0c0; font-weight: bold;">:x</span> 0 <span style="color: #e3b0c0; font-weight: bold;">:y</span> 0<span style="color: #e47980;">)</span>
                        <span style="color: #e3b0c0; font-weight: bold;">:width</span> 500
                        <span style="color: #e3b0c0; font-weight: bold;">:height</span> 500<span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span>window-add-renderable *win* *axis*<span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span>axis-add-renderable *axis* <span style="color: #e3b0c0; font-weight: bold;">:mandelbrot</span><span style="color: #ffaacf;">)</span>
  <span style="color: #ffaacf;">(</span>sb-thread:make-thread <span style="color: #80aadf;">(</span><span style="color: #deb07a; font-weight: bold;">lambda</span> <span style="color: #e47980;">()</span> <span style="color: #e47980;">(</span>window-run *win*<span style="color: #e47980;">)</span><span style="color: #80aadf;">)</span><span style="color: #ffaacf;">)</span><span style="color: #deb07a;">)</span>
</pre>
</div>

<p>
use <code>(mandelbrot-test)</code> to run this (obviously)
she's pretty but slow as fuck
to kill the window now we have to press "q" continuously, because the main loop doesnt reach the code that checks whether a key is pressed until the frame has finished drawing, and the mandelbrot takes some time to draw
</p>
</div>
</div>
</div>
</body>
</html>
